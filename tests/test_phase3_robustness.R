# ==============================================================================
# tests/test_phase3_robustness.R
# ==============================================================================
# PURPOSE: Unit tests for Phase 3A robustness infrastructure\n# DEPENDS: R/functions/robustness.R, R/functions/logging.R\n# ==============================================================================\n\ncat(\"\\n[TEST] Phase 3A: Robustness Infrastructure\\n\")\ncat(\"=\"*60, \"\\n\")\n\n# Source required modules\nsource(here::here(\"R\", \"functions\", \"robustness.R\"))\nsource(here::here(\"R\", \"functions\", \"logging.R\"))\nsource(here::here(\"R\", \"functions\", \"assertions.R\"))\n\ntest_count <- 0\npassed_count <- 0\n\n# =============================================================================\n# Test 1: Result Object Creation\n# =============================================================================\ntest_create_result <- function() {\n  cat(\"\\n  Test 1: Result object creation... \")\n  test_count <<- test_count + 1\n  \n  tryCatch(\n    {\n      result <- create_result(\"test_operation\", verbose = FALSE)\n      \n      # Verify structure\n      stopifnot(\n        is.list(result),\n        !is.null(result$status),\n        result$status == \"unknown\",\n        !is.null(result$timestamp),\n        is.list(result$errors),\n        length(result$errors) == 0,\n        is.list(result$warnings),\n        length(result$warnings) == 0,\n        result$operation == \"test_operation\",\n        is.numeric(result$duration_secs),\n        result$duration_secs == 0\n      )\n      \n      cat(\"✓\\n\")\n      passed_count <<- passed_count + 1\n    },\n    error = function(e) {\n      cat(sprintf(\"✗ %s\\n\", e$message))\n    }\n  )\n}\n\n# =============================================================================\n# Test 2: Status Transitions\n# =============================================================================\ntest_status_transitions <- function() {\n  cat(\"\\n  Test 2: Status transitions... \")\n  test_count <<- test_count + 1\n  \n  tryCatch(\n    {\n      # Transition: unknown → success\n      result <- create_result(\"test\", verbose = FALSE)\n      result <- set_result_status(result, \"success\", \"Test passed\", FALSE)\n      stopifnot(result$status == \"success\", \n                result$message == \"Test passed\")\n      \n      # Transition: success → partial (via warning)\n      result <- create_result(\"test\", verbose = FALSE)\n      result <- set_result_status(result, \"success\", \"OK\", FALSE)\n      result <- add_warning(result, \"Some issues\", FALSE)\n      stopifnot(result$status == \"partial\")\n      \n      # Transition: unknown → failed (via error)\n      result <- create_result(\"test\", verbose = FALSE)\n      result <- add_error(result, \"Test error\", FALSE)\n      stopifnot(result$status == \"failed\")\n      \n      cat(\"✓\\n\")\n      passed_count <<- passed_count + 1\n    },\n    error = function(e) {\n      cat(sprintf(\"✗ %s\\n\", e$message))\n    }\n  )\n}\n\n# =============================================================================\n# Test 3: Quality Score Computation\n# =============================================================================\ntest_quality_score_computation <- function() {\n  cat(\"\\n  Test 3: Quality score with weights... \")\n  test_count <<- test_count + 1\n  \n  tryCatch(\n    {\n      result <- create_result(\"test\", verbose = FALSE)\n      \n      # Add quality metrics: 0.3*85 + 0.5*90 + 0.2*75 = 25.5 + 45 + 15 = 85.5\n      result <- add_quality_metrics(result,\n        list(c1 = 85, c2 = 90, c3 = 75),\n        list(w1 = 0.3, w2 = 0.5, w3 = 0.2)\n      )\n      \n      stopifnot(\n        !is.na(result$quality_score),\n        abs(result$quality_score - 85.5) < 0.1\n      )\n      \n      # Boundary: all 100\n      result <- create_result(\"test\", verbose = FALSE)\n      result <- add_quality_metrics(result,\n        list(c1 = 100, c2 = 100),\n        list(w1 = 0.5, w2 = 0.5)\n      )\n      stopifnot(result$quality_score == 100)\n      \n      # Boundary: all 0\n      result <- create_result(\"test\", verbose = FALSE)\n      result <- add_quality_metrics(result,\n        list(c1 = 0, c2 = 0),\n        list(w1 = 0.5, w2 = 0.5)\n      )\n      stopifnot(result$quality_score == 0)\n      \n      cat(\"✓\\n\")\n      passed_count <<- passed_count + 1\n    },\n    error = function(e) {\n      cat(sprintf(\"✗ %s\\n\", e$message))\n    }\n  )\n}\n\n# =============================================================================\n# Test 4: Error and Warning Lists\n# =============================================================================\ntest_error_warning_lists <- function() {\n  cat(\"\\n  Test 4: Error and warning accumulation... \")\n  test_count <<- test_count + 1\n  \n  tryCatch(\n    {\n      # Multiple errors\n      result <- create_result(\"test\", verbose = FALSE)\n      result <- add_error(result, \"Error 1\", FALSE)\n      result <- add_error(result, \"Error 2\", FALSE)\n      stopifnot(\n        length(result$errors) == 2,\n        result$status == \"failed\",\n        \"Error 1\" %in% result$errors,\n        \"Error 2\" %in% result$errors\n      )\n      \n      # Multiple warnings\n      result <- create_result(\"test\", verbose = FALSE)\n      result <- add_warning(result, \"Warning 1\", FALSE)\n      result <- add_warning(result, \"Warning 2\", FALSE)\n      stopifnot(\n        length(result$warnings) == 2,\n        result$status == \"partial\",\n        \"Warning 1\" %in% result$warnings,\n        \"Warning 2\" %in% result$warnings\n      )\n      \n      cat(\"✓\\n\")\n      passed_count <<- passed_count + 1\n    },\n    error = function(e) {\n      cat(sprintf(\"✗ %s\\n\", e$message))\n    }\n  )\n}\n\n# =============================================================================\n# Test 5: Timing Functions\n# =============================================================================\ntest_timing_functions <- function() {\n  cat(\"\\n  Test 5: Timer accuracy (100ms tolerance)... \")\n  test_count <<- test_count + 1\n  \n  tryCatch(\n    {\n      start <- start_timer()\n      Sys.sleep(0.15)  # 150ms delay\n      elapsed <- stop_timer(start)\n      \n      stopifnot(\n        !is.na(elapsed),\n        is.numeric(elapsed),\n        elapsed >= 0.1,\n        elapsed < 1.0\n      )\n      \n      cat(\"✓\\n\")\n      passed_count <<- passed_count + 1\n    },\n    error = function(e) {\n      cat(sprintf(\"✗ %s\\n\", e$message))\n    }\n  )\n}\n\n# =============================================================================\n# Test 6: Error Message Formatting\n# =============================================================================\ntest_error_message_formatting <- function() {\n  cat(\"\\n  Test 6: Error message formatting... \")\n  test_count <<- test_count + 1\n  \n  tryCatch(\n    {\n      msg <- format_error_message(\n        \"operation_test\",\n        \"Something went wrong\",\n        \"Check parameters\"\n      )\n      \n      stopifnot(\n        is.character(msg),\n        nchar(msg) > 0,\n        grepl(\"operation_test\", msg),\n        grepl(\"Something went wrong\", msg),\n        grepl(\"Check parameters\", msg)\n      )\n      \n      cat(\"✓\\n\")\n      passed_count <<- passed_count + 1\n    },\n    error = function(e) {\n      cat(sprintf(\"✗ %s\\n\", e$message))\n    }\n  )\n}\n\n# =============================================================================\n# Test 7: Result Success Predicate\n# =============================================================================\ntest_is_result_success <- function() {\n  cat(\"\\n  Test 7: is_result_success predicate... \")\n  test_count <<- test_count + 1\n  \n  tryCatch(\n    {\n      # Success case\n      result <- create_result(\"test\", verbose = FALSE)\n      result <- set_result_status(result, \"success\", \"OK\", FALSE)\n      stopifnot(is_result_success(result) == TRUE)\n      \n      # Partial case (still ok to proceed)\n      result <- set_result_status(result, \"partial\", \"Warning\", FALSE)\n      stopifnot(is_result_success(result) == TRUE)\n      \n      # Failed case (cannot proceed)\n      result <- set_result_status(result, \"failed\", \"Error\", FALSE)\n      stopifnot(is_result_success(result) == FALSE)\n      \n      cat(\"✓\\n\")\n      passed_count <<- passed_count + 1\n    },\n    error = function(e) {\n      cat(sprintf(\"✗ %s\\n\", e$message))\n    }\n  )\n}\n\n# =============================================================================\n# Run All Tests\n# =============================================================================\ntest_create_result()\ntest_status_transitions()\ntest_quality_score_computation()\ntest_error_warning_lists()\ntest_timing_functions()\ntest_error_message_formatting()\ntest_is_result_success()\n\ncat(sprintf(\"\\n  Summary: %d/%d passed\\n\", passed_count, test_count))\ncat(\"=\"*60, \"\\n\\n\")\n\n# Return counts for aggregation\ninvisible(list(passed = passed_count, total = test_count))\n