# Phase 1.7: report.R Migration (Add Parameter)
**Target:** core/report.R  
**Source:** R/functions/output/report.R  
**Approach:** Option A - Add output_prefix parameter  
**Complexity:** â­ Simple  
**Estimated Time:** 30 minutes  
**Risk Level:** ğŸŸ¢ Low  
**Status:** Ready to Execute

---

## Prerequisites
- âœ… Sub-Phase 0.1.6 audit complete (0.1.6_report_audit.md)
- âœ… Quarto rendering logic analyzed (100% universal)
- âœ… Dependencies identified (quarto, here packages)

---

## Executive Summary

**Current State:**
```
R/functions/output/report.R  (214 lines, 1 function)
  - generate_quarto_report()  [145 lines] - has hardcoded filename prefix
```

**Target State:**
```
core/report.R  (215 lines, 1 function - refactored)
  - generate_quarto_report()  [145 lines] - PARAMETERIZED with output_prefix
```

**Change:** Add 1 parameter, modify 1 line of code, backward compatible with default

---

## File Analysis Summary

**File:** R/functions/output/report.R  
**Lines:** 214  
**Functions:** 1

| Component | Status | Changes? |
|-----------|--------|----------|
| Quarto rendering logic | âœ… Ready | None (already universal) |
| RDS handling | âœ… Ready | None (already parameterized) |
| Path defaults | âœ… Ready | None (already parameterized) |
| Output filename | ğŸŸ¡ Hardcoded | Add parameter |

**Hardcoded Element:**
```r
# Line 158
output_file <- sprintf("coha_dispersal_report_%s.html", timestamp)  # â† PREFIX HARDCODED
```

**Dependencies:**
- External: quarto, here
- Internal: None (standalone)

---

## Implementation Plan

### Step 1: Update Function Signature

**OLD:**
```r
generate_quarto_report <- function(all_summaries,
                                   all_plots,
                                   study_params_path = here::here("inst", "config", "study_parameters.yaml"),
                                   template_path = here::here("reports", "full_analysis_report.qmd"),
                                   output_dir = here::here("results", "reports"),
                                   quiet = FALSE)
```

**NEW:**
```r
generate_quarto_report <- function(all_summaries,
                                   all_plots,
                                   study_params_path = here::here("inst", "config", "study_parameters.yaml"),
                                   template_path = here::here("reports", "full_analysis_report.qmd"),
                                   output_dir = here::here("results", "reports"),
                                   output_prefix = "coha_dispersal_report",  # â† NEW PARAMETER
                                   quiet = FALSE)
```

### Step 2: Update Roxygen Documentation

Add to the roxygen2 @param block:

```r
#' @param output_prefix Character. Filename prefix for generated report.
#'   Default: "coha_dispersal_report"
#'   Example values: "migration_report", "climate_analysis", "biodiversity_study"
#'   The generated file will be named: {output_prefix}_{date}.html
```

### Step 3: Modify Filename Generation

**OLD (Line 158):**
```r
timestamp <- format(Sys.Date(), "%Y%m%d")
output_file <- sprintf("coha_dispersal_report_%s.html", timestamp)
```

**NEW:**
```r
timestamp <- format(Sys.Date(), "%Y%m%d")
output_file <- sprintf("%s_%s.html", output_prefix, timestamp)  # â† Uses parameter
```

---

## Usage Examples

### Example 1: COHA (Default - Backward Compatible)

```r
# Old code still works - uses default prefix
report_path <- generate_quarto_report(
  all_summaries = summary_list,
  all_plots = plot_list
)
# Creates: coha_dispersal_report_20260212.html
```

### Example 2: Migration Study (Custom Prefix)

```r
# New code with custom prefix (only new line added!)
report_path <- generate_quarto_report(
  all_summaries = migration_summaries,
  all_plots = migration_plots,
  template_path = "reports/migration_analysis.qmd",
  output_dir = "output/migration_reports",
  output_prefix = "migration_analysis"  # â† Only new addition
)
# Creates: migration_analysis_20260212.html
```

### Example 3: Temperature Model

```r
report_path <- generate_quarto_report(
  all_summaries = temp_summaries,
  all_plots = temp_plots,
  template_path = "reports/climate_report.qmd",
  output_dir = "output/climate_reports",
  output_prefix = "climate_study_results"
)
# Creates: climate_study_results_20260212.html
```

### Example 4: Multiple Reports (Date-Parameterized)

```r
# Generate multiple reports in sequence
for (dataset in c("coha", "migration", "temperature")) {
  summaries <- load_summaries(dataset)
  plots <- load_plots(dataset)
  
  report_path <- generate_quarto_report(
    summaries, plots,
    output_prefix = paste0(dataset, "_analysis")
  )
  cat(sprintf("âœ“ Generated: %s\n", basename(report_path)))
}
# Creates:
#   - coha_analysis_20260212.html
#   - migration_analysis_20260212.html
#   - temperature_analysis_20260212.html
```

---

## Testing Plan

### Test 1: Backward Compatibility (Critical)

```r
# Test 1a: Old code works with no changes
report_path <- generate_quarto_report(
  all_summaries = test_summaries,
  all_plots = test_plots
)

# Verify output filename has COHA default
expected_filename <- sprintf("coha_dispersal_report_%s.html", format(Sys.Date(), "%Y%m%d"))
actual_filename <- basename(report_path)

stopifnot(actual_filename == expected_filename,
          file.exists(report_path))
cat("âœ“ Backward compatibility maintained\n")
```

### Test 2: Custom Prefix Works

```r
# Test 2a: New parameter works
report_path <- generate_quarto_report(
  all_summaries = test_summaries,
  all_plots = test_plots,
  output_prefix = "custom_prefix"
)

expected_filename <- sprintf("custom_prefix_%s.html", format(Sys.Date(), "%Y%m%d"))
actual_filename <- basename(report_path)

stopifnot(actual_filename == expected_filename,
          file.exists(report_path))
cat("âœ“ Custom prefix works correctly\n")
```

### Test 3: Various Prefix Styles

```r
test_prefixes <- c(
  "migration_report",
  "simple",
  "report_v2",
  "2025_climate_study"
)

for (prefix in test_prefixes) {
  report_path <- generate_quarto_report(
    all_summaries = test_summaries,
    all_plots = test_plots,
    output_prefix = prefix,
    quiet = TRUE  # Suppress output during testing
  )
  
  expected_filename <- sprintf("%s_%s.html", prefix, format(Sys.Date(), "%Y%m%d"))
  actual_filename <- basename(report_path)
  
  stopifnot(actual_filename == expected_filename,
            message = sprintf("Prefix '%s' failed", prefix))
}

cat("âœ“ All prefix styles work\n")
```

### Test 4: Empty/NULL Prefix Handling

```r
# Test edge case: what if someone passes empty string?
# (decide if this should error or fall back to default)

# Option A: Allow empty string (generates "_YYYYMMDD.html")
report_path <- generate_quarto_report(
  test_summaries, test_plots,
  output_prefix = ""  # Edge case
)
# Creates: _20260212.html

# Option B: Validate non-empty (recommended)
if (is.null(output_prefix) || output_prefix == "") {
  output_prefix <- "coha_dispersal_report"  # Fallback to default
}
```

**Recommendation:** Add validation at function start:

```r
# Validate output_prefix
if (!is.character(output_prefix) || output_prefix == "") {
  stop("output_prefix must be a non-empty string")
}
```

---

## Validation Checklist

- [ ] Function signature updated with output_prefix parameter
- [ ] Default value set to "coha_dispersal_report"
- [ ] Roxygen documentation updated
- [ ] Filename generation line changed (sprintf with parameter)
- [ ] Backward compatibility test passes
- [ ] Custom prefix test passes
- [ ] Various prefix styles work
- [ ] Input validation added (non-empty string)
- [ ] File is copied to core/report.R
- [ ] All existing integration still works

---

## Code Changes Summary

**Lines Changed:** 3 (minimal!)
1. Line ~87: Add parameter to function signature
2. Line ~158: Modify sprintf call to use parameter
3. Line ~XX: Add roxygen @param documentation

**Lines Deleted:** 0  
**Lines Added:** 5-10 (parameter, documentation, validation)  
**Breaking Changes:** None (backward compatible with default)

---

## Git Workflow

```bash
# Create feature branch
git checkout -b phase/1.7-report-output-prefix

# Edit R/functions/output/report.R
# - Add output_prefix parameter to signature
# - Update filename generation line
# - Update roxygen docs

# Copy to core/
cp R/functions/output/report.R core/report.R

# Test changes
# ... run tests ...

# Stage
git add core/report.R
git add R/functions/output/report.R  # Updated source

# Commit
git commit -m "Phase 1.7: Add output_prefix parameter to generate_quarto_report()"

# Merge after testing
git checkout main
git merge phase/1.7-report-output-prefix
```

---

## Integration Points

**What depends on report.R?**
- Pipeline orchestrator (calls generate_quarto_report())
- Final publication workflow
- Results archival

**Do they need changes?** 
- No! Default behavior unchanged
- Existing calls work without modification

**Will they benefit from new parameter?**
- Yes! Future analyses can customize report names

---

## Risk Assessment

| Risk | Probability | Impact | Mitigation |
|------|-------------|--------|------------|
| **Breaking change** | Very Low | Medium | Default value maintains COHA behavior |
| **Empty prefix bug** | Low | Low | Add input validation |
| **Encoding issue** | Very Low | Low | Use base R sprintf (safe) |

**Overall Risk Level:** ğŸŸ¢ Very Low

---

## Time Breakdown

| Task | Time |
|------|------|
| Add parameter to signature | 2 min |
| Update filename generation | 2 min |
| Add roxygen documentation | 3 min |
| Add input validation | 2 min |
| Testing | 12 min |
| Git workflow | 3 min |
| **Total** | **24 min** |

---

## Success Criteria

âœ… **Migration Complete When:**
1. output_prefix parameter added to signature
2. Default value set to "coha_dispersal_report"
3. Filename generation uses parameter
4. Input validation checks for non-empty string
5. Roxygen documentation updated
6. Backward compatibility test passes (old behavior)
7. Custom prefix test passes (new behavior)
8. File copied to core/report.R
9. All integration tests pass
10. No breaking changes to existing pipeline calls

---

## Optional Enhancements (Phase 2)

**If you want even more flexibility in Phase 2:**
- Add `output_format` parameter (html, pdf, docx)
- Add timestamp format customization
- Load prefix from config file

**For now:** Keep simple (just the prefix parameter)

---

## Next Steps

After testing and validation:
1. âœ… Verify file copied to core/report.R
2. âœ… Return to Phase 1.8 (coha_release.R migration)
3. âœ… After all migrations: Phase 1.9 (cleanup & deduplication)

---

**Status:** Ready for Execution  
**Approach:** Option A (Add parameter) - Simple & Clean  
**Effort:** ~30 minutes  
**Risk:** Very Low (backward compatible)  
**Next:** Code changes â†’ Testing â†’ Verification

