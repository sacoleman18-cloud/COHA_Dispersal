# Phase 1.8: coha_release.R Migration
**Target:** domain_modules/coha_dispersal/release.R  
**Source:** R/functions/coha_release.R  
**Complexity:** ‚≠ê‚≠ê Moderate  
**Estimated Time:** 45 minutes  
**Risk Level:** üü¢ Low  
**Status:** Ready to Execute

---

## Prerequisites
- ‚úÖ Sub-Phase 0.1.5 audit complete (0.1.3-0.1.6 summary + analysis)
- ‚úÖ All COHA hardcodes identified
- ‚úÖ Domain module structure exists
- ‚úÖ Test COHA dataset available

---

## Executive Summary

**Current State:**
```
R/functions/coha_release.R  (285 lines, 2 functions - 100% COHA-specific)
  - create_release_bundle()    [~150 lines] - COHA hardcoded
  - cleanup_old_artifacts()    [~100 lines] - COHA hardcoded
```

**Target State:**
```
domain_modules/coha_dispersal/release.R  (285 lines, identical)
  - create_release_bundle()    [~150 lines] - unchanged
  - cleanup_old_artifacts()    [~100 lines] - unchanged
```

**Change:** File relocation only (no code changes - this is correct for domain-specific code)

---

## Why Move to Domain?

**This file contains 100% COHA-specific logic:**

```r
# Hardcoded study name
study_name = "COHA_Dispersal"

# Hardcoded paths (COHA structure)
results/plots/ridgeline/variants
results/reports

# Hardcoded naming conventions
staging_name <- sprintf("coha_release_%s", timestamp)

# Implicit assumptions:
# - Release artifacts exist in COHA locations
# - Staging directory follows COHA naming
# - Cleanup targets COHA-specific files
```

**No reusable patterns:** Release management is entirely COHA-focused, not adaptable

**Domain Module is correct home:** This code belongs with other COHA-specific operations

---

## File Analysis Summary

**File:** R/functions/coha_release.R  
**Lines:** 285  
**Functions:** 2 (both 100% COHA-specific)

| Function | Type | Status | Action |
|----------|------|--------|--------|
| create_release_bundle | COHA | 100% COHA | Move to domain/ as-is |
| cleanup_old_artifacts | COHA | 100% COHA | Move to domain/ as-is |

**Dependencies:**
- External: none (file operations only)
- Internal: No internal function dependencies
- Paths: Assumes COHA directory structure

**Hardcoded Values:**
- "COHA_Dispersal" (study name)
- "coha_release_" (staging prefix)
- ridgeline plot paths
- report paths

---

## Step-by-Step Migration

### Step 1: Verify Domain Module Structure

```r
# Check domain module directory exists
dir.exists("domain_modules/coha_dispersal")  # Should be TRUE

# Check what files already exist there
list.files("domain_modules/coha_dispersal/")
```

### Step 2: Copy File to Domain Module

```r
# Copy coha_release.R to domain module
file.copy(
  "R/functions/coha_release.R",
  "domain_modules/coha_dispersal/release.R",
  overwrite = TRUE
)

# Verify copy
file.exists("domain_modules/coha_dispersal/release.R")  # Should be TRUE
```

### Step 3: Verify File Integrity

```r
# Compare file sizes
size_old <- file.info("R/functions/coha_release.R")$size
size_new <- file.info("domain_modules/coha_dispersal/release.R")$size

stopifnot(size_old == size_new,
          message = "File sizes don't match!")

# Line count check
lines_old <- length(readLines("R/functions/coha_release.R"))
lines_new <- length(readLines("domain_modules/coha_dispersal/release.R"))

stopifnot(lines_old == lines_new,
          message = "Line counts don't match!")

cat(sprintf("‚úì File copied successfully (%d lines, %.1f KB)\n",
            lines_new, size_new / 1024))
```

### Step 4: Source and Test Functions

```r
# Source the domain module version
source("domain_modules/coha_dispersal/release.R")

# Test that functions are available
stopifnot(exists("create_release_bundle"),
          exists("cleanup_old_artifacts"))

# Verify function signatures
formals(create_release_bundle)
formals(cleanup_old_artifacts)

cat("‚úì All functions sourced and available\n")
```

### Step 5: Integration Testing

```r
# Test with actual COHA workflow (non-destructive)

# Verify path assumptions
results_dir <- here::here("results")
plots_dir <- file.path(results_dir, "plots", "ridgeline", "variants")
reports_dir <- file.path(results_dir, "reports")

# Check expected directories exist
cat(sprintf("Results dir: %s -> %s\n", 
            results_dir, 
            ifelse(dir.exists(results_dir), "‚úì", "‚úó")))

cat(sprintf("Plots dir: %s -> %s\n", 
            plots_dir, 
            ifelse(dir.exists(plots_dir), "‚úì", "‚úó")))

cat(sprintf("Reports dir: %s -> %s\n", 
            reports_dir, 
            ifelse(dir.exists(reports_dir), "‚úì", "‚úó")))

# Could test create_release_bundle() with dry_run or test mode
# if such parameters exist
```

---

## Validation Checklist

- [ ] Domain module directory exists
- [ ] File copied to domain_modules/coha_dispersal/release.R
- [ ] File size matches original (285 lines)
- [ ] Both functions source without errors
- [ ] Function signatures unchanged
- [ ] Functions are callable
- [ ] Path assumptions match COHA structure
- [ ] No integration breaks in existing pipeline

---

## No Code Changes Needed

**This is intentional:** coha_release.R is properly COHA-specific. 

The entire file belongs in the domain module because:
1. ‚úÖ All logic is COHA-specific
2. ‚úÖ No reusable patterns exist
3. ‚úÖ No universal functions mixed in
4. ‚úÖ Dependencies are minimal (just file I/O)
5. ‚úÖ Moving it doesn't break core/ universality

**Decision:** Move as-is, no refactoring

---

## Update Call Sites

**After Phase 1.8 complete, Phase 1.9 will:**
1. Update source paths in load.R
2. Update any direct calls in pipeline scripts
3. Update module loading order

**For Phase 1.8 specifically:** Just move the file

---

## Integration with Domain Module

**Where to source this in domain module:**

```r
# domain_modules/coha_dispersal/_load.R or load.R
source(here::here("domain_modules/coha_dispersal/release.R"))
source(here::here("domain_modules/coha_dispersal/assertions.R"))  # From Phase 1.2
source(here::here("domain_modules/coha_dispersal/data_quality.R"))  # If using domain wrapper
```

**Order matters:**
1. Core utilities first
2. COHA-specific functions second
3. Domain functions last

---

## Git Workflow

```bash
# Create feature branch
git checkout -b phase/1.8-coha-release-move

# Copy file
cp R/functions/coha_release.R domain_modules/coha_dispersal/release.R

# Stage copy (don't delete original yet)
git add domain_modules/coha_dispersal/release.R

# Commit
git commit -m "Phase 1.8: Move COHA-specific release.R to domain module"

# Keep original in R/functions for now (Phase 1.9 cleanup)
```

---

## Risk Assessment

| Risk | Probability | Impact | Mitigation |
|------|-------------|--------|------------|
| **Path assumption issue** | Low | Medium | Verify directory structure exists |
| **Missing dependency** | Low | Low | Check file I/O ops (built-in) |
| **Orphaned references** | Medium | Low | Fix in Phase 1.9 (script updates) |

**Overall Risk Level:** üü¢ Low

---

## Time Breakdown

| Task | Time |
|------|------|
| Verify domain structure | 2 min |
| Copy file | 2 min |
| Verify integrity | 3 min |
| Source and test | 10 min |
| Integration testing | 15 min |
| Git workflow | 3 min |
| Documentation | 5 min |
| **Total** | **40 min** |

---

## Success Criteria

‚úÖ **Migration Complete When:**
1. domain_modules/coha_dispersal/release.R exists
2. File is byte-identical to source
3. Both create_release_bundle() and cleanup_old_artifacts() source without errors
4. Functions are callable and have correct signatures
5. COHA path structure is verified
6. No integration breaks in existing pipeline
7. Git commit created

---

## Next Steps

After this step:
1. ‚úÖ Proceed to Phase 1.9 (cleanup & deduplication)
2. ‚úÖ Return to all copied files and update source references

---

## Notes

- **Pure File Move:** No code changes, no refactoring
- **Correct Decision:** COHA-specific code belongs in domain module
- **Clean Separation:** Universal core/ never sees COHA paths/names
- **Easy Rollback:** Delete file from domain/ if needed (original still in R/functions)

---

**Status:** Ready for Execution  
**Approach:** Simple file copy (100% COHA-specific, no parameterization possible)  
**Effort:** 40 minutes  
**Risk:** Low (minimal dependencies, pure file relocation)  
**Next:** Execute copy and verify functions work, then Phase 1.9 cleanup

