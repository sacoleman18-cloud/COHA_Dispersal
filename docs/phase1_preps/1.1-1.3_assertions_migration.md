# Phase 1 Prep: assertions.R Migration (Option B)
**Status:** Ready for Implementation  
**Date:** February 12, 2026  
**Effort Estimate:** 1-2 hours  
**Risk Level:** Low

---

## Phase 1 Task Summary

**Objective:** Migrate 13 universal assertion functions from `R/functions/core/assertions.R` to new `core/assertions.R`, and move domain-specific `validate_ridgeline_data()` to domain module.

**Outcome:** 
- ✅ 13 universal functions available in `core/assertions.R`
- ✅ 1 domain-specific function in `domain_modules/coha_dispersal/data_loader.R`
- ✅ All call sites updated
- ✅ No breaking changes to pipeline

---

## Change Set 1: Create `core/assertions.R` (New File)

**File:** `core/assertions.R`  
**Action:** Create new file with 13 universal functions  
**Source Lines:** From `R/functions/core/assertions.R` lines 1-314 + 354-575

**Contains:**
- File header (updated path)
- All 13 universal assertion functions
- All roxygen2 documentation
- All imports (base R only)

**Excludes:**
- `validate_ridgeline_data()` (lines 315-353)

**Size:** ~538 lines

---

## Change Set 2: Create `domain_modules/coha_dispersal/data_loader.R` (New File)

**File:** `domain_modules/coha_dispersal/data_loader.R`  
**Action:** Create new file with domain-specific validation  
**Source:** `R/functions/core/assertions.R` lines 315-353

**Contains:**
```r
# ==============================================================================
# domain_modules/coha_dispersal/data_loader.R
# ==============================================================================
# PURPOSE
# -------
# COHA-specific data loading and validation for ridgeline analysis.
# Domain-specific version of assertions validated in core/assertions.R
#
# DEPENDS ON
# ----------
# - core/assertions.R (universal assertion functions)
# - h ere (path management)
#
# IMPORTS
# -------
source(here::here("core", "assertions.R"))

#' Validate Ridgeline Plot Data (COHA-Specific)
#'
#' @description
#' Comprehensive schema validation for COHA ridgeline plot data.
#' Performs all critical checks: type, shape, and completeness.
#' Stops pipeline on any failure with clear error messages.
#'
#' @param df Data frame. Data to validate for ridgeline plotting.
#' @param verbose Logical. Print validation details to console.
#'   Default: FALSE.
#'
#' @return Invisible logical TRUE if all checks pass.
#'   Stops execution with error message if any check fails.
#'
#' @details
#' **Validation Checks (in order):**
#' 1. Input is a data frame
#' 2. Contains required columns: mass, year, dispersed
#' 3. Data is not empty (has at least 1 row)
#' 4. Column types are correct (mass, year numeric; dispersed character)
#' 5. Key columns (mass, year) have no NA values
#'
#' **verbose=TRUE output:** Shows each check with ✓ indicator, useful for debugging
#' data issues. Should be used during development and troubleshooting.
#'
#' **Design:** Composite function using individual assertions from core/ module.
#' Performs all checks in logical sequence, stopping at first failure.
#' Uses tryCatch for NA check so minor NA issues produce warning, not error.
#'
#' @examples
#' \dontrun{
#' # After loading data, validate before plotting
#' data <- readr::read_csv(here::here("data", "data.csv"))
#' validate_ridgeline_data(data, verbose = TRUE)  # Shows detailed output
#'
#' # Then proceed with pipeline
#' plots <- generate_all_ridgeline_plots(data)
#' }
#'
#' @export
validate_ridgeline_data <- function(df, verbose = FALSE) {
  # Check is data frame
  if (!is.data.frame(df)) {
    stop("Input must be a data frame", call. = FALSE)
  }
  if (verbose) message("[VALIDATE] ✓ Input is data frame")
  
  # Check required columns exist
  required_cols <- c("mass", "year", "dispersed")
  assert_columns_exist(df, required_cols, context = "ridgeline data")
  if (verbose) message("[VALIDATE] ✓ All required columns present")
  
  # Check not empty
  assert_not_empty(df, context = "ridgeline data")
  if (verbose) message("[VALIDATE] ✓ Data contains ", nrow(df), " rows")
  
  # Check column types
  assert_is_numeric(df, "mass", context = "ridgeline validation")
  assert_is_numeric(df, "year", context = "ridgeline validation")
  assert_is_character(df, "dispersed", context = "ridgeline validation")
  if (verbose) message("[VALIDATE] ✓ Column types correct")
  
  # Check for NAs in key columns
  tryCatch(
    {
      assert_no_na(df, "mass", context = "ridgeline mass data")
      assert_no_na(df, "year", context = "ridgeline year data")
    },
    error = function(e) {
      warning("Data contains NA values - may impact ridgeline plot", 
              call. = FALSE)
    }
  )
  
  if (verbose) message("[VALIDATE] ✓ Ridgeline data validation complete")
  invisible(TRUE)
}
```

**Size:** ~45 lines

---

## Change Set 3: Update `R/pipeline/pipeline.R`

**Action:** Update sourcing and function calls

### Sub-change 3a: Add new source call for core/assertions.R

**Location:** Near top of file where other `source()` calls exist  
**Current:** Already sources functions, but from old locations  
**Change:** Add explicit source for `core/assertions.R`

```r
# Before
source(here::here("R", "functions", "core", "assertions.R"))

# After
source(here::here("core", "assertions.R"))
```

### Sub-change 3b: Add source for domain module data_loader

**Location:** Same area as data loading setup  
**Add:**
```r
source(here::here("domain_modules", "coha_dispersal", "data_loader.R"))
```

### Sub-change 3c: Verify no other references

**Search for:**
```powershell
Get-Content R/pipeline/pipeline.R | Select-String "validate_ridgeline_data|assert_"
```

**Expected:** A few uses of the functions. No changes needed—same functions, just different locations.

---

## Change Set 4: Update Any Other Files That Source assertions.R

**Search for:** `source.*assertions`

```powershell
Get-ChildItem -Recurse -Filter "*.R" | 
  Select-String 'source.*assertions' | 
  Select Path, LineNumber, Line
```

**Expected locations:**
- `R/pipeline/pipeline.R` - Update per Change Set 3
- Possibly other scripts - update as found

**Update Pattern:**
```r
# Before
source(here::here("R", "functions", "core", "assertions.R"))

# After
source(here::here("core", "assertions.R"))
```

---

## Directory Structure Changes

### Current (Before Phase 1)
```
R/functions/core/assertions.R      ← Source of truth
domain_modules/                    ← Doesn't exist yet
```

### After Phase 1
```
core/assertions.R                  ← New universal location
domain_modules/coha_dispersal/
  └─ data_loader.R                 ← New domain-specific location
```

### Backward Compatibility
Keep old `R/functions/core/assertions.R` file for now (full copy). Remove in Phase 3 cleanup.

---

## Implementation Checklist

### Pre-Implementation Tests
- [ ] Run current pipeline successfully (baseline)
- [ ] Capture test outputs (`results/plots/`, `results/reports/`)
- [ ] Document all passing tests

### Implementation Steps

**Step 1: Create `core/assertions.R`**
- [ ] Create directory: `core/`
- [ ] Create file: `core/assertions.R`
- [ ] Copy 13 universal functions from source
- [ ] Update file header (new path)
- [ ] Verify file syntax (source it, no errors)

**Step 2: Create `domain_modules/coha_dispersal/` structure**
- [ ] Create directory: `domain_modules/coha_dispersal/`
- [ ] Create file: `data_loader.R`
- [ ] Add `validate_ridgeline_data()` function
- [ ] Add source call for `core/assertions.R`
- [ ] Verify file syntax (source it, no errors)

**Step 3: Update `R/pipeline/pipeline.R`**
- [ ] Update sourcing of `core/assertions.R` (line ~35-40)
- [ ] Add sourcing of domain module data_loader (line ~43-44)
- [ ] Verify pipeline loads without errors

**Step 4: Verify Call Sites**
- [ ] Search for all uses of `validate_ridgeline_data()`
- [ ] Search for all uses of `assert_*()` functions
- [ ] Verify they work with new locations
- [ ] Test pipeline end-to-end

### Post-Implementation Tests
- [ ] Run pipeline with verbose=TRUE
- [ ] Generate all 28 ridgeline plots
- [ ] Verify data validation catches bad inputs
- [ ] Render all 3 reports
- [ ] Compare outputs to baseline
- [ ] Git diff to review all changes

### Verification
- [ ] `source("core/assertions.R")` works
- [ ] `source("domain_modules/coha_dispersal/data_loader.R")` works
- [ ] Pipeline runs without errors
- [ ] All plots generate
- [ ] All reports render
- [ ] Error messages are clear and helpful

---

## Git Workflow

### Branch Strategy
```bash
git checkout -b phase1-assertions-migration
```

### Commits
1. **Commit 1:** Create `core/assertions.R`
   ```
   [Phase 1.1] Create core/assertions.R with 13 universal assertion functions
   
   - Extract 13 universal validation functions from R/functions/core/assertions.R
   - Keep zero external dependencies (base R only)
   - Full roxygen2 documentation preserved
   - Ready for reuse across any analysis
   ```

2. **Commit 2:** Create `domain_modules/coha_dispersal/data_loader.R`
   ```
   [Phase 1.2] Create domain module data_loader with COHA-specific validation
   
   - Move validate_ridgeline_data() to domain module
   - Uses universal assertions from core/
   - COHA-specific column names and schema
   - Maintains backward compatibility
   ```

3. **Commit 3:** Update pipeline sourcing
   ```
   [Phase 1.3] Update R/pipeline/pipeline.R to use new module locations
   
   - Update source() calls to new locations
   - Add domain module imports
   - No functional changes, just path updates
   - All tests pass
   ```

### Merge to Main
```bash
git merge --no-ff phase1-assertions-migration -m "Phase 1.1-1.3: assertions.R migration complete"
```

---

## Rollback Plan

If issues arise, rollback is simple:

```bash
git revert HEAD~2          # Revert to before this work
git reset --hard HEAD@{1}  # Or hard reset back
```

Or, keep old files and revert sourcing:
```r
# Revert pipeline.R to use old locations temporarily
source(here::here("R", "functions", "core", "assertions.R"))
```

---

## Success Criteria

Phase 1 is complete when:

- [x] ✅ 13 universal functions in `core/assertions.R`
- [x] ✅ 1 domain-specific function in domain module
- [x] ✅ Pipeline runs without errors
- [x] ✅ All 28 plots generate successfully
- [x] ✅ All 3 reports render correctly
- [x] ✅ Data validation catches bad inputs
- [x] ✅ Error messages are clear
- [x] ✅ No breaking changes for users

---

## Risk Assessment & Mitigations

| Risk | Probability | Impact | Mitigation |
|------|-------------|--------|------------|
| **Missed function dependencies** | Low | High | grep all R files for assert_ usage before/after |
| **Broken sourcing order** | Medium | High | Test sourcing immediately after each change |
| **Pipeline breaks** | Low | High | Run full pipeline after each commit |
| **Report rendering fails** | Low | Medium | Test report generation end-to-end |
| **Lost code** | Very Low | Critical | Git checkouts, clear commits with messages |

**Overall Risk Level:** ✅ **Low**

---

## Time Breakdown

| Task | Time |
|------|------|
| Create `core/assertions.R` | 20 min |
| Create `domain_modules/coha_dispersal/data_loader.R` | 15 min |
| Update `R/pipeline/pipeline.R` | 15 min |
| Search & verify all call sites | 15 min |
| Test & validation | 30 min |
| Git commit & review | 15 min |
| **TOTAL** | **110 minutes** (~2 hours) |

---

## Notes for Implementation

1. **Don't delete old files yet** - Keep `R/functions/core/assertions.R` until we've verified everything works
2. **Test frequently** - After each major change, source files and run pipeline
3. **Update documentation** - Add notes about domain-specific functions in domain module README
4. **Keep error messages clear** - All assert functions have good messages, maintain them
5. **Version control** - Clear, specific commit messages help future understanding

---

## Integration with Broader Phase 1

This migration happens in **Phase 1.1-1.3**. Future Phase 1 work:
- 1.4-1.5: Migrate other `core/` functions
- 1.6-1.8: Extract data operations, quality metrics, robustness
- 1.9: Create core engine orchestrator

This work is self-contained and doesn't block later phases.

---

**Status:** ✅ Phase 1 Prep Complete - Ready to Execute  
**Next Step:** Continue with Sub-Phase 0.1.2 (Audit `config.R`)

