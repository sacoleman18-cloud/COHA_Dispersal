# Sub-Phase 0.2 Audit: Core Utility Functions (robustness, logging, utilities)
**Files Audited:** 3 core files (1,421 lines, ~25 functions)  
**Components:** Result objects, logging, file I/O, path generation  
**Date:** February 12, 2026  
**Status:** âœ… 100% READY FOR CORE/ - All 25 functions universal

---

## Overview

Sub-Phase 0.2 completes the audit of tier-1 utilities that support all pipeline operations. These are foundational functions with minimal dependencies, providing structured results, audit trails, and safe I/O.

**Key Finding:** ğŸŸ¢ **All 25 functions are 100% universal - no COHA logic whatsoever**

---

## File 1: robustness.R (425 lines)
**Location:** R/functions/robustness.R  
**Status:** âœ… 100% Universal  
**Recommendation:** Move to core/robustness.R as-is

### Function Inventory

| Function | Lines | Type | Purpose | COHA Logic? |
|----------|-------|------|---------|------------|
| create_result | 30 | Core | Initialize structured result object | âŒ No |
| set_result_status | 25 | Core | Update status and message | âŒ No |
| add_error | 20 | Core | Append error to result | âŒ No |
| add_warning | 25 | Core | Append warning to result | âŒ No |
| add_quality_metrics | 60 | Core | Compute and attach quality score | âŒ No |
| start_timer | 10 | Core | Record operation start time | âŒ No |
| stop_timer | 15 | Core | Calculate elapsed time | âŒ No |
| format_error_message | 20 | Core | Format error with context | âŒ No |
| is_result_success | 10 | Core | Query result status | âŒ No |

### Key Design (Universal Patterns)

**Result Object Structure:**
```r
list(
  status = "unknown|success|partial|failed",
  message = "human-readable explanation",
  timestamp = Sys.time(),
  duration_secs = numeric,
  operation = "operation name",
  errors = list(),
  warnings = list(),
  quality_score = 0-100
)
```

**No COHA References:**
- âœ… No column names (mass, year, dispersed)
- âœ… No file paths hardcoded
- âœ… No COHA study assumptions
- âœ… No plot-type specific logic
- âœ… All field names are generic

**Universal Usage:**
```r
result <- create_result("any_operation")
result <- add_quality_metrics(result, list(completeness = 95, accuracy = 88))
if (is_result_success(result)) { proceed() }
```

### Dependencies
- Base R only (no external packages)
- Calls: log_message() (from logging.R) - will be co-located in core/

### Summary
- **Functions:** 9, all universal
- **Hardcodes:** 0
- **COHA Logic:** 0
- **Breaking Changes:** None
- **Ready for Core:** âœ… YES

---

## File 2: logging.R (406 lines)
**Location:** R/functions/core/logging.R  
**Status:** âœ… 100% Universal  
**Recommendation:** Move to core/logging.R as-is

### Function Inventory

| Function | Lines | Type | Purpose | COHA Logic? |
|----------|-------|------|---------|------------|
| initialize_pipeline_log | 50 | Core | Init logging, create logs/ dir | âŒ No |
| get_log_file | 25 | Core | Query today's log path | âŒ No |
| log_message | 60 | Core | Core logging, timestamped | âŒ No |
| log_entry | 20 | Core | Log operation start | âŒ No |
| log_success | 25 | Core | Log successful completion | âŒ No |
| log_error | 20 | Core | Log operation failure | âŒ No |
| show_log | 40 | Core | Display log file to console | âŒ No |

### Key Design (Universal Patterns)

**Logging Format:**
```r
[YYYY-MM-DD HH:MM:SS] [LEVEL] message
# Example:
[2026-02-10 14:30:45] [INFO] [START] Loading data
```

**Log Levels:** ERROR, WARN, INFO, DEBUG (standard, not COHA-specific)

**File Structure:**
```
logs/
  pipeline_2026-02-10.log  (date-based, calendar day = one file)
  pipeline_2026-02-11.log
  ... (creates new file per day)
```

**No COHA References:**
- âœ… No COHA-specific study names
- âœ… No plot type naming
- âœ… No domain assumptions
- âœ… Works for ANY analysis
- âœ… Generic operation names

**Universal Usage:**
```r
initialize_pipeline_log()  # Works for any analysis
log_entry("Loading migration data")
log_success("Analysis", "5000 records processed")
log_error("Validation check", "Missing columns")
show_log()  # View recent operations
```

### Dependencies
- `here` package (standard path management)
- Base R for file operations
- No internal dependencies

### Summary
- **Functions:** 7, all universal
- **Hardcodes:** 0 (just standard logging directory names)
- **COHA Logic:** 0
- **Breaking Changes:** None
- **Ready for Core:** âœ… YES

---

## File 3: utilities.R (590 lines)
**Location:** R/functions/core/utilities.R  
**Status:** âœ… 100% Universal  
**Recommendation:** Move to core/utilities.R as-is

### Function Inventory

| Function | Lines | Type | Purpose | COHA Logic? |
|----------|-------|------|---------|------------|
| %\|\|% | 15 | Operator | Null coalescing operator | âŒ No |
| ensure_dir_exists | 15 | Core | Create directory recursively | âŒ No |
| safe_read_csv | 70 | Core | Safe CSV import with error handling | âŒ No |
| convert_empty_to_na | 40 | Core | Clean CSV data (emptyâ†’NA) | âŒ No |
| make_output_path | 20 | Core | Generate timestamped output path | âŒ No |
| find_most_recent_file | 80 | Core | Find latest file matching pattern | âŒ No |
| make_versioned_path | 30 | Core | Generate auto-incremented path | âŒ No |
| fill_readme_template | 50 | Core | Populate README template | âŒ No |

### Key Design (Universal Patterns)

**Null Coalescing Operator:**
```r
value <- NULL %||% "default"  # Returns "default"
value <- "actual" %||% "default"  # Returns "actual"
```

**Safe I/O Pattern:**
```r
# Returns NULL on failure (doesn't stop pipeline)
df <- safe_read_csv("data/file.csv", error_log_path = "logs/errors.log")
if (is.null(df)) {
  warning("Data loading failed")
  df <- fallback_data()
}
```

**Path Generation (Timestamped):**
```r
# Deterministic timestamp for reproducibility
path <- make_output_path("summary", "csv", "results")
# â†’ "results/summary_20260210_143530.csv"
```

**File Discovery (Pattern-Based):**
```r
# Find most recent RDS matching pattern
latest <- find_most_recent_file(
  directory = "results/rds",
  pattern = "^plot_results_.*\\.rds$"
)
```

**No COHA References:**
- âœ… All function names are generic (not specific to COHA)
- âœ… Timestamps are standard (YYYYMMDD_HHMMSS)
- âœ… No file path assumptions beyond top-level directories
- âœ… Pattern matching is regex-generic
- âœ… Template filling works for any README

**Universal Usage:**
```r
# Migration study
ensure_dir_exists("migration_results/plots")
df <- safe_read_csv("migration_data.csv")
df <- convert_empty_to_na(df, c("origin", "dest"))
path <- make_output_path("migration_summary", "csv", "migration_results")

# Climate model
ensure_dir_exists("climate_output")
df <- safe_read_csv("temperature_data.csv")
latest <- find_most_recent_file("climate_output", "results_.*\\.rds$")
```

### Dependencies
- `readr` package (read_csv)
- `here` package (path management)
- `dplyr` package (for convert_empty_to_na's mutate)
- `lubridate` package (optional, for timestamp parsing in find_most_recent_file)
- Base R

**All standard, no COHA-specific packages**

### Summary
- **Functions:** 8+ (operators, functions)
- **Hardcodes:** 0 (all parameterized)
- **COHA Logic:** 0
- **Breaking Changes:** None
- **Ready for Core:** âœ… YES

---

## Cross-File Analysis

### Dependency Network
```
utilities.R         (base dependencies: readr, here, dplyr, lubridate)
    â†“
logging.R           (imports utilities: ensure_dir_exists, log_message)
    â†“
robustness.R        (imports logging: log_message, log_error)
    â†“
[Everything else]   (can import from core: utilities, logging, robustness)
```

**Key Point:** Minimal circular dependencies, clean layering

### Combined Statistics

| Metric | Value |
|--------|-------|
| **Total Lines** | 1,421 |
| **Total Functions** | ~25 |
| **100% Universal** | âœ… 25/25 |
| **COHA-Specific** | âŒ 0/25 |
| **External Packages** | 4 (readr, here, dplyr, lubridate - all standard) |
| **Hardcoded COHA Values** | âŒ 0 |

### Quality Metrics

**Universality:** ğŸŸ¢ 100%
- No COHA references
- No plot-type specific logic
- No domain assumptions
- All parameters generic

**Dependencies:** ğŸŸ¢ Clean
- Only standard packages
- No internal dependencies (except logging â†’ robustness)
- All external deps are portable

**Reusability:** ğŸŸ¢ High
- All functions work with ANY analysis
- Generic naming (no COHA in function names)
- Example usage patterns shown for non-COHA domains

**Documentation:** ğŸŸ¢ Complete
- Roxygen2 docs with @examples
- Usage patterns shown
- Design contracts documented

---

## Migration Readiness

### All 25 Functions Ready for Movement
No refactoring needed. Files can be moved directly to core/:

```
core/
  utilities.R     â† safe_read_csv, path generation, file discovery
  logging.R       â† audit trail, timestamped logging
  robustness.R    â† structured results, quality metrics
```

### No Phase 1 Prep Docs Needed

Unlike data_quality.R and report.R, these files need no preparation documents:
- âœ… No parameterization decisions needed
- âœ… No hardcoded values to extract
- âœ… No refactoring planned
- âœ… Already perfect for core/

Just straight movement + testing.

### Phase 1 Execution Plan

After all Sub-Phase 0.1 migrations complete (assertions, config, console, data_quality, coha_release, report):

**Phase 1.9a - Move Sub-Phase 0.2 Files:**
```
1. Copy utilities.R to core/utilities.R (590 lines)
2. Copy logging.R to core/logging.R (406 lines)
3. Copy robustness.R to core/robustness.R (425 lines)
4. Test all 25 functions load without errors
5. Update sourcing order in load.R
6. Git commit
```

**Estimated Effort:** 1.5-2 hours total

**Risk:** Very Low ğŸŸ¢
- Pure file copies (no code changes)
- No dependencies on other files being moved
- All functions are isolated utilities
- Easy to test individually

---

## Integration with Phase 1 Architecture

### Sourcing Order (After Phase 1)
```r
# core/ - Foundation layer
source("core/utilities.R")    # No deps, move first
source("core/logging.R")      # Deps: utilities
source("core/robustness.R")   # Deps: logging
source("core/assertions.R")   # Deps: base R (from 0.1.1)
source("core/config.R")       # Deps: yaml, here (from 0.1.2)
source("core/console.R")      # Deps: base R (from 0.1.3)
source("core/data_quality.R") # Deps: assertions, logging, robustness (from 0.1.4)
source("core/report.R")       # Deps: quarto, here (from 0.1.7)

# domain_modules/
source("domain_modules/coha_dispersal/assertions.R")      # COHA-specific (from 0.1.1)
source("domain_modules/coha_dispersal/data_quality.R")    # COHA wrapper (from 0.1.6)
source("domain_modules/coha_dispersal/release.R")         # COHA release (from 0.1.8)

# plot_modules/
source("plot_modules/ridgeline/operations.R")

# orchestration/
source("coha_pipeline_orchestrator.R")
```

**Key Point:** Sub-Phase 0.2 functions form the foundational layer. All other code depends on them.

---

## Validation Plan (Phase 1.9a)

### Test Suite for Sub-Phase 0.2

```r
# Test utilities.R
source("core/utilities.R")
test_that("utilities functions load", {
  expect_true(exists("%||%"))
  expect_true(exists("ensure_dir_exists"))
  expect_true(exists("safe_read_csv"))
  expect_true(exists("convert_empty_to_na"))
  expect_true(exists("make_output_path"))
  expect_true(exists("find_most_recent_file"))
  expect_true(exists("make_versioned_path"))
  expect_true(exists("fill_readme_template"))
})

# Test logging.R
source("core/logging.R")
test_that("logging functions load", {
  expect_true(exists("initialize_pipeline_log"))
  expect_true(exists("get_log_file"))
  expect_true(exists("log_message"))
  expect_true(exists("log_entry"))
  expect_true(exists("log_success"))
  expect_true(exists("log_error"))
  expect_true(exists("show_log"))
})

# Test robustness.R
source("core/robustness.R")
test_that("robustness functions load", {
  expect_true(exists("create_result"))
  expect_true(exists("set_result_status"))
  expect_true(exists("add_error"))
  expect_true(exists("add_warning"))
  expect_true(exists("add_quality_metrics"))
  expect_true(exists("start_timer"))
  expect_true(exists("stop_timer"))
  expect_true(exists("format_error_message"))
  expect_true(exists("is_result_success"))
})

# Test basic functionality
test_that("result workflow works", {
  result <- create_result("test_op")
  result <- set_result_status(result, "success", "Test passed")
  result <- add_quality_metrics(result, list(a = 95, b = 85))
  expect_equal(result$status, "success")
  expect_true(is_result_success(result))
  expect_true(result$quality_score > 80)
})

test_that("logging works", {
  log_file <- initialize_pipeline_log()
  log_entry("Test operation")
  expect_true(file.exists(log_file))
})

test_that("null coalescing works", {
  expect_equal(NULL %||% "default", "default")
  expect_equal("value" %||% "default", "value")
})
```

---

## Summary Table: Sub-Phase 0.2 Complete

| Aspect | Status | Details |
|--------|--------|---------|
| **robustness.R** | âœ… Ready | 9 functions, 100% universal |
| **logging.R** | âœ… Ready | 7 functions, 100% universal |
| **utilities.R** | âœ… Ready | 8+ functions, 100% universal |
| **Total Functions** | âœ… 25 | All universal |
| **Hardcoded COHA Values** | âŒ 0 | None found |
| **Refactoring Needed** | âŒ No | Move as-is |
| **Dependencies** | âœ… Clean | Standard packages, no circular deps |
| **Ready for Phase 1** | âœ… YES | Can move immediately |

---

## Not Yet Audited

### Plot Operations (Not Core)
- `plot_operations.R` (697 lines) - Plot type-specific operations
- **Status:** Should stay in plot_modules/ (not core/)
- **Note:** Audit not required for Phase 0.1-0.2 (not universal)

### Other Optional Audits
- `orchestration.R` or main pipeline script
- Domain-specific modules (domain_modules/coha_dispersal/)
- Output generation modules

**Decision:** Skip these for now (out of scope for "universal core" extraction)

---

## Continuation Plan

### Next Immediate Steps

1. **Complete Sub-Phase 0.2 Documentation** âœ… (This document)
2. **Execute Phase 1 Migrations** (all prep docs created)
   - Migrations for Sub-Phase 0.1 files (2-4 hours)
   - Migrations for Sub-Phase 0.2 files (1-2 hours as part of Phase 1.9a)
3. **Phase 1.9 Cleanup**
   - Remove moved files from R/functions/
   - Update all sourcing paths
   - Update import references

### Phase 1 Order of Execution

**Recommended sequence** (quick wins first, then complex):
1. Phase 1.4: config.R â†’ core/ (30 min) ğŸŸ¢
2. Phase 1.5: console.R â†’ core/ (20 min) ğŸŸ¢
3. Phase 1.7: report.R + parameter â†’ core/ (30 min) ğŸŸ¢
4. Phase 1.2: assertions.R migration (1.5-2 hrs) ğŸŸ¡
5. Phase 1.6: data_quality.R parameterization (2-3 hrs) ğŸŸ 
6. Phase 1.8: coha_release.R â†’ domain/ (45 min) ğŸŸ¢
7. Phase 1.9a: utilities, logging, robustness to core/ (1.5-2 hrs) ğŸŸ¢
8. Phase 1.9b: Cleanup & final testing (1-2 hrs) ğŸŸ¡

**Total Phase 1 Effort:** 8-12 hours (distributed across 3-4 days)

---

## Conclusion

### Sub-Phase 0.2 Summary

All 25 utility functions across 3 files (robustness.R, logging.R, utilities.R) are **100% universal**.

**No parameterization needed.** No hardcoded COHA values. No plot-type specific logic.

These form the **foundational utility layer** that all other code depends on.

**Ready to move immediately to core/ after Phase 1 begins.**

---

## Quick Reference: Function Summary

**robustness.R (9 functions)**
- Result object management
- Quality metrics computation
- Error/warning handling
- Operation timing

**logging.R (7 functions)**
- File-based logging with timestamps
- Console control
- Log level management
- Log viewing utilities

**utilities.R (8+ functions)**
- Safe I/O (CSV reading with error handling)
- Path generation (timestamped, versioned)
- File discovery (pattern-based, most recent)
- Directory management
- Data cleaning (empty string â†’ NA)
- Null coalescing operator
- Template filling

**Total: 25 universal utility functions ready for core/**

---

**Status:** Sub-Phase 0.2 âœ… COMPLETE  
**All files ready:** âœ… YES  
**Refactoring needed:** âŒ NO  
**Next:** Execute Phase 1 migrations

