# Sub-Phase 0.1.6 Audit: report.R (Detailed)
**File:** `R/functions/output/report.R`  
**Lines:** 214  
**Date Audited:** February 12, 2026  
**Status:** ⚠️ **50% Universal Pattern, 50% COHA-Specific Hardcodes**

---

## Executive Summary

**Assessment:** Core Quarto rendering logic is completely universal, but path and filename patterns are hardcoded for COHA.

**Functions:** 1 main function (report generation)

**Key Issue:** Output filename and directory paths assume COHA project structure

**Recommendation:** **Option A (Parameterize paths) or Option B (Minor refactoring)**

---

## Function Inventory

### 1. `generate_quarto_report()`

**Location:** Lines 70-214

**Purpose:** Render Quarto .qmd template with pre-computed summaries and plot objects

**Signature:**
```r
generate_quarto_report <- function(all_summaries,
                                   all_plots,
                                   study_params_path = here::here("inst", "config", "study_parameters.yaml"),
                                   template_path = here::here("reports", "full_analysis_report.qmd"),
                                   output_dir = here::here("results", "reports"),
                                   quiet = FALSE)
```

**Assessment:** ✅ **Signature is 50% parameterized already**

Accepts as parameters:
- ✅ `all_summaries` - flexible (path or object)
- ✅ `all_plots` - flexible (path or object)
- ✅ `study_params_path` - parameterized but COHA default
- ✅ `template_path` - parameterized but COHA default
- ✅ `output_dir` - parameterized but COHA default
- ✅ `quiet` - flexible

---

## Hardcoded Values Identified

### Critical Hardcode: Output Filename (Line 158)

```r
timestamp <- format(Sys.Date(), "%Y%m%d")
output_file <- sprintf("coha_dispersal_report_%s.html", timestamp)  # ← HARDCODED PREFIX
```

**Problem:** Always creates `coha_dispersal_report_YYYYMMDD.html`

**COHA-Specific?** ✅ YES - "coha_dispersal" hardcoded in filename

**Impact:** Reports generated by this function always have COHA-specific prefix

**Example outputs:**
- coha_dispersal_report_20260212.html ✅ (COHA only)
- Should support: migration_report_20260212.html, temperature_report_20260212.html, etc. ❌

### Secondary: Path Defaults (Lines 87-89)

```r
study_params_path = here::here("inst", "config", "study_parameters.yaml"),  # ← COHA structure
template_path = here::here("reports", "full_analysis_report.qmd"),           # ← COHA structure
output_dir = here::here("results", "reports"),                               # ← COHA structure
```

**Assessment:** ✅ **Parameterized but COHA-defaulted**
- All have default values
- Can be overridden by caller
- But defaults assume COHA project structure

**Example calls needed for other domains:**
```r
# Migration study
generate_quarto_report(
  all_summaries = migration_summaries,
  all_plots = migration_plots,
  study_params_path = here::here("config/migration_params.yaml"),    # ← Must override
  template_path = here::here("reports/migration_analysis.qmd"),       # ← Must override
  output_dir = here::here("output/migration_reports")                 # ← Must override
)
```

**Problem:** User must override 3+ parameters for non-COHA use

---

## Core Logic Assessment

### Universal Elements ✅

**Quarto Rendering (Lines 149-152):**
```r
quarto::quarto_render(
  input = template_path,
  output_file = output_file,
  output_format = "html",
  execute_dir = here::here(),  # ← SMART DESIGN (universal)
  execute_params = list(
    summary_rds = summary_rds_path,
    plots_rds = plots_rds_path,
    study_params_path = study_params_path
  ),
  quiet = quiet
)
```

**Assessment:** ✅ Completely generic
- No COHA references
- Works with any template, summaries, plots
- Properly handles working directory (critical!)
- Executes from project root (smart for load_all.R sourcing)

**RDS Handling (Lines 103-121):**
```r
# Accept both paths and objects
if (is.character(all_summaries)) {
  if (!file.exists(all_summaries)) { stop(...) }
  summary_rds_path <- all_summaries
  all_summaries <- readRDS(all_summaries)
} else {
  summary_rds_path <- tempfile(fileext = ".rds")
  saveRDS(all_summaries, summary_rds_path)
}
```

**Assessment:** ✅ Generic and flexible
- Handles both paths and objects
- No COHA references
- Reusable for any analysis

**File Management (Lines 166-181):**
```r
if (!dir.exists(output_dir)) {
  dir.create(output_dir, recursive = TRUE)
}
# ... render ...
if (file.exists(rendered_path) && rendered_path != final_path) {
  file.rename(rendered_path, final_path)
}
if (!file.exists(final_path)) {
  stop("Report generation failed...")
}
```

**Assessment:** ✅ Generic file I/O
- No COHA assumptions
- Works with any directory structure

### Dependencies

**External packages:**
- ✅ `quarto` - report rendering (universal)
- ✅ `here` - path management (universal)
- ✅ `yaml` (mentioned in header, not actually used in function body)

**Internal dependencies:**
- ❌ None (standalone function - good!)

---

## Recommendation

### Option A: Parameterize Output Filename ✅ RECOMMENDED

**Effort:** 15 minutes (single parameter addition)

**Result:** Universal function works for any report type

```r
generate_quarto_report <- function(all_summaries,
                                   all_plots,
                                   study_params_path = here::here("inst", "config", "study_parameters.yaml"),
                                   template_path = here::here("reports", "full_analysis_report.qmd"),
                                   output_dir = here::here("results", "reports"),
                                   output_prefix = "coha_dispersal_report",  # ← NEW PARAMETER
                                   quiet = FALSE) {
  
  timestamp <- format(Sys.Date(), "%Y%m%d")
  output_file <- sprintf("%s_%s.html", output_prefix, timestamp)  # ← Uses parameter
}
```

**Usage for different domains:**
```r
# COHA (default)
generate_quarto_report(summaries, plots)
# → Creates: coha_dispersal_report_20260212.html

# Migration study (custom prefix)
generate_quarto_report(
  summaries, plots,
  output_prefix = "migration_analysis",    # ← Only new line needed!
  template_path = "reports/migration.qmd"
  output_dir = "output/reports"
)
# → Creates: migration_analysis_20260212.html

# Temperature model
generate_quarto_report(
  summaries, plots,
  output_prefix = "climate_report",
  template_path = "reports/climate.qmd"
)
# → Creates: climate_report_20260212.html
```

**Backward compatible:** Default value maintains COHA behavior

---

### Option B: Move to Domain Module (Simpler)

**Effort:** 15 minutes (move + minimal edits)

**Result:** COHA-specific version in domain module

```r
# R/functions/output/report.R (keep as universal)
generate_quarto_report <- function(all_summaries,
                                   all_plots,
                                   study_params_path,
                                   template_path,
                                   output_dir,
                                   output_prefix,  # ← Required (no default)
                                   quiet = FALSE) {
  # ... same code ...
}

# domain_modules/coha_dispersal/report.R (COHA wrapper)
generate_coha_report <- function(all_summaries, all_plots, quiet = FALSE) {
  generate_quarto_report(
    all_summaries = all_summaries,
    all_plots = all_plots,
    study_params_path = here::here("inst", "config", "study_parameters.yaml"),
    template_path = here::here("reports", "full_analysis_report.qmd"),
    output_dir = here::here("results", "reports"),
    output_prefix = "coha_dispersal_report",
    quiet = quiet
  )
}
```

**Advantages:**
- ✅ Simple: COHA users call `generate_coha_report()`
- ✅ Universal core doesn't assume project structure
- ✅ New domains create their own wrappers

**Disadvantages:**
- ❌ Wrapper just passes parameters (minor code duplication)

---

### Option C: Config-Based Default (Most Elegant)

**Effort:** 30 minutes (with config integration)

**Result:** Load from study_parameters.yaml

```yaml
# inst/config/study_parameters.yaml
report:
  output_prefix: coha_dispersal_report
  template_path: reports/full_analysis_report.qmd
  output_dir: results/reports
```

```r
generate_quarto_report <- function(all_summaries,
                                   all_plots,
                                   study_params_path = here::here("inst", "config", "study_parameters.yaml"),
                                   output_prefix = NULL,
                                   template_path = NULL,
                                   output_dir = NULL,
                                   quiet = FALSE) {
  
  # Load defaults from config
  config <- yaml::read_yaml(study_params_path)
  
  if (is.null(output_prefix)) output_prefix <- config$report$output_prefix
  if (is.null(template_path)) template_path <- config$report$template_path
  if (is.null(output_dir)) output_dir <- config$report$output_dir
  
  # ... rest of function ...
}
```

**Advantages:**
- ✅ Centralized configuration (DRY principle)
- ✅ Domain-specific values in YAML (not hardcoded)
- ✅ Easy to override individual parameters

**Disadvantages:**
- ❌ Requires config file updates
- ❌ More complex than Option A

---

## Comparison

| Aspect | Option A | Option B | Option C |
|--------|----------|----------|----------|
| **Effort** | 15 min | 15 min | 30 min |
| **Simplicity** | High | High | Medium |
| **Universality** | Universal | Wrapper pattern | Universal |
| **Configuration** | Parameter | Function defaults | YAML config |
| **New domains** | 3 params override | Create wrapper | 1 param override |
| **Backward compat** | ✅ Full | ✅ Full | ✅ Full |
| **Code clarity** | High | Very high | Very high |

---

## Recommendation: **Option A**

**Reasoning:**
1. Simplest to implement (one parameter)
2. Maintains backward compatibility (defaults to COHA behavior)
3. Minimal code changes
4. Flexible for all use cases
5. Doesn't require config updates

**Implementation:**

Add one parameter to function signature:
```r
generate_quarto_report <- function(all_summaries,
                                   all_plots,
                                   study_params_path = here::here("inst", "config", "study_parameters.yaml"),
                                   template_path = here::here("reports", "full_analysis_report.qmd"),
                                   output_dir = here::here("results", "reports"),
                                   output_prefix = "coha_dispersal_report",  # ← ADD THIS
                                   quiet = FALSE)
```

Change one line (158):
```r
# OLD:
output_file <- sprintf("coha_dispersal_report_%s.html", timestamp)

# NEW:
output_file <- sprintf("%s_%s.html", output_prefix, timestamp)
```

**Testing:**
```r
# COHA call (should work unchanged)
generate_quarto_report(summaries, plots)

# Migration call
generate_quarto_report(summaries, plots, output_prefix = "migration_report")

# Verify backward compatibility
old_result <- generate_quarto_report(s, p)  # Default behavior
new_result <- generate_quarto_report(s, p, output_prefix = "coha_dispersal_report")  # Explicit
# Both should produce identical filenames
```

---

## Risk Assessment

| Risk | Probability | Impact | Mitigation |
|------|-------------|--------|------------|
| **Breaking change** | Low | Medium | Use default parameter, same as current |
| **Signature change** | Low | Low | Backward compatible (new optional param) |
| **Path assumption issues** | Low | Low | Parameters already exist for paths |

---

## Integration Notes

**Phase 1.6 (if proceeding with Option A):**

1. Add `output_prefix` parameter to signature (1 line)
2. Update filename generation (1 line)
3. Update roxygen docs (document new parameter)
4. Test with both COHA default and custom prefix
5. Update any direct calls in pipeline (if any)

**Migration impact:** Minimal
- Default behavior unchanged
- Existing code works without modification
- New code can use custom prefixes

---

## Conclusion

### Current State
- ✅ Core Quarto rendering logic: 100% universal
- ✅ RDS handling: 100% universal
- ✅ File I/O and validation: 100% universal
- ❌ Output filename: 100% COHA-specific

### Recommended State
- ✅ Parameterize output filename with default = "coha_dispersal_report"
- ✅ Move function to core/report.R (universal)
- ✅ All core report generation functionality reusable

### End Result
Function can be used by any analysis without modification to core code, while maintaining COHA's specific report naming convention as default behavior.

---

**Status:** Sub-Phase 0.1.6 Complete  
**Recommendation:** Option A (add output_prefix parameter)  
**Next:** Complete Sub-Phase 0.2 (dependency graph audit)

