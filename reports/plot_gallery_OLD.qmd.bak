---
title: "COHA Ridgeline Plot Gallery"
subtitle: "24 Variants | Side-by-Side Scale Comparisons | Interactive Selection Guide"
author: "COHA Research Team"
date: "`r Sys.Date()`"
format:
  html:
    toc: true
    toc-depth: 2
    code-fold: show
    theme: flatly
    embed-resources: true
    grid:
      body-width: 1200px
execute:
  echo: false
  warning: false
  message: false
---

```{r setup}
#| include: false

library(here)
library(tidyverse)
library(ggplot2)
library(ggridges)
library(knitr)
library(kableExtra)

# Source pipeline
source(here::here("R", "pipeline", "pipeline.R"))
```

# Overview

This gallery showcases **20 ridgeline plot variants** for visualizing Cooper's Hawk (COHA) mass distributions across years. Each variant explores different aesthetic combinations of scale and palette.

## Gallery Structure

### 1. All Variants (20 Tabs)
Browse individual plots at full size. Each variant combines a specific scale (compact or expanded) with one of 10 color palettes. Variants 1-10 use compact scale (0.85), variants 11-20 use expanded scale (2.25).

### 2. Scale Comparison by Palette (10 Tabs)
Compare compact vs expanded **side-by-side** for each palette. This section helps you quickly identify the best scale and palette combination by viewing both options simultaneously with variant numbers displayed.

## Quick Selection Guide

**To choose a plot variant:**  
1. Scroll to **Scale Comparison** → Browse the 10 palette tabs  
2. Compare compact vs expanded side-by-side  
3. Note your preferred variant number (1-20)  
4. Return to **All Variants** → Open that variant's tab for full view

```{r run-pipeline}
#| cache: true

# Generate all plots
result <- run_pipeline(verbose = FALSE, use_registry = TRUE)

# Phase 3: Load plots from artifact registry (not plot_results)
registry_path <- here::here("R", "config", "artifact_registry.yaml")
if (file.exists(registry_path)) {
  registry <- yaml::read_yaml(registry_path)
} else {
  registry <- result$registry  # Fallback to pipeline result
}

# Build plot lookup from registry
plot_lookup <- list()
if (!is.null(registry) && !is.null(registry$artifacts)) {
  # Get all ridgeline plot artifacts
  plot_artifacts <- Filter(
    function(x) x$type == "ridgeline_plots",
    registry$artifacts
  )
  
  # Sort by name for consistent ordering
  plot_artifacts <- plot_artifacts[order(names(plot_artifacts))]
  
  # Create lookup by artifact name
  for (artifact_name in names(plot_artifacts)) {
    artifact <- plot_artifacts[[artifact_name]]
    plot_lookup[[artifact_name]] <- list(
      file_path = artifact$file_path,
      quality_score = artifact$metadata$quality_score %||% NA,
      palette = artifact$metadata$palette %||% "unknown",
      generation_time = artifact$metadata$generation_time %||% NA
    )
  }
}

# Helper function to render plot by artifact name (e.g., "compact_01")
render_plot_by_name <- function(plot_name, alt_text = "Plot not available") {
  if (plot_name %in% names(plot_lookup)) {
    path <- plot_lookup[[plot_name]]$file_path
    if (!is.null(path) && file.exists(path)) {
      return(knitr::include_graphics(path))
    }
  }
  cat(alt_text, "\n")
  return(invisible(NULL))
}

# Helper to get quality score
get_quality <- function(plot_name) {
  if (plot_name %in% names(plot_lookup)) {
    return(plot_lookup[[plot_name]]$quality_score %||% 0)
  }
  0
}

# Helper to get generation time
get_time <- function(plot_name) {
  if (plot_name %in% names(plot_lookup)) {
    return(plot_lookup[[plot_name]]$generation_time %||% NA)
  }
  NA
}

# Summary stats
total_plots <- length(plot_lookup)
success_rate <- if (total_plots > 0) 100 else 0
avg_quality <- if (total_plots > 0) {
  mean(sapply(plot_lookup, function(x) x$quality_score %||% 0), na.rm = TRUE)
} else {
  0
}
```

**Total Variants Generated:** `r total_plots`  
**Success Rate:** `r sprintf("%.0f%%", success_rate)`  
**Average Quality:** `r sprintf("%.0f/100", avg_quality)`

---

# All Variants

Browse all 20 ridgeline plot variants. Each tab shows a unique combination of scale and palette.

::: {.panel-tabset}

## Variant 1: Compact + Plasma

```{r variant-01}
#| fig-height: 6
#| fig-width: 8

render_plot_by_name("compact_01")
```

**Quality:** `r sprintf("%.0f/100", get_quality("compact_01"))`

## Variant 2: Compact + Viridis

```{r variant-02}
#| fig-height: 6
#| fig-width: 8

render_plot_by_name("compact_02")
```

**Quality:** `r sprintf("%.0f/100", get_quality("compact_02"))`

## Variant 3: Compact + Magma

```{r variant-03}
#| fig-height: 6
#| fig-width: 8

render_plot_by_name("compact_03")
```

**Quality:** `r sprintf("%.0f/100", get_quality("compact_03"))`

## Variant 4: Compact + Inferno

```{r variant-04}
#| fig-height: 6
#| fig-width: 8

render_plot_by_name("compact_04")
```

**Quality:** `r sprintf("%.0f/100", get_quality("compact_04"))`

## Variant 5: Compact + Cividis

```{r variant-05}
#| fig-height: 6
#| fig-width: 8

render_plot_by_name("compact_05")
```

**Quality:** `r sprintf("%.0f/100", get_quality("compact_05"))`

## Variant 6: Compact + Rocket

```{r variant-06}
#| fig-height: 6
#| fig-width: 8

render_plot_by_name("compact_06")
```

**Quality:** `r sprintf("%.0f/100", get_quality("compact_06"))`

## Variant 7: Compact + Mako

```{r variant-07}
#| fig-height: 6
#| fig-width: 8

render_plot_by_name("compact_07")
```

**Quality:** `r sprintf("%.0f/100", get_quality("compact_07"))`

## Variant 8: Compact + Turbo

```{r variant-08}
#| fig-height: 6
#| fig-width: 8

render_plot_by_name("compact_08")
```

**Quality:** `r sprintf("%.0f/100", get_quality("compact_08"))`

## Variant 9: Compact + Set2

```{r variant-09}
#| fig-height: 6
#| fig-width: 8

render_plot_by_name("compact_09")
```

**Quality:** `r sprintf("%.0f/100", get_quality("compact_09"))`

## Variant 10: Compact + Dark2

```{r variant-10}
#| fig-height: 6
#| fig-width: 8

render_plot_by_name("compact_10")
```

**Quality:** `r sprintf("%.0f/100", get_quality("compact_10"))`

## Variant 11: Expanded + Plasma

```{r variant-11}
#| fig-height: 6
#| fig-width: 8

render_plot_by_name("expanded_01")
```

**Quality:** `r sprintf("%.0f/100", get_quality("expanded_01"))`

## Variant 12: Expanded + Viridis

```{r variant-12}
#| fig-height: 6
#| fig-width: 8

render_plot_by_name("expanded_02")
```

**Quality:** `r sprintf("%.0f/100", get_quality("expanded_02"))`

## Variant 13: Expanded + Magma

```{r variant-13}
#| fig-height: 6
#| fig-width: 8

render_plot_by_name("expanded_03")
```

**Quality:** `r sprintf("%.0f/100", get_quality("expanded_03"))`

## Variant 14: Expanded + Inferno

```{r variant-14}
#| fig-height: 6
#| fig-width: 8

render_plot_by_name("expanded_04")
```

**Quality:** `r sprintf("%.0f/100", get_quality("expanded_04"))`

## Variant 15: Expanded + Cividis

```{r variant-15}
#| fig-height: 6
#| fig-width: 8

render_plot_by_name("expanded_05")
```

**Quality:** `r sprintf("%.0f/100", get_quality("expanded_05"))`

## Variant 16: Expanded + Rocket

```{r variant-16}
#| fig-height: 6
#| fig-width: 8

render_plot_by_name("expanded_06")
```

**Quality:** `r sprintf("%.0f/100", get_quality("expanded_06"))`

## Variant 17: Expanded + Mako

```{r variant-17}
#| fig-height: 6
#| fig-width: 8

render_plot_by_name("expanded_07")
```

**Quality:** `r sprintf("%.0f/100", get_quality("expanded_07"))`

## Variant 18: Expanded + Turbo

```{r variant-18}
#| fig-height: 6
#| fig-width: 8

render_plot_by_name("expanded_08")
```

**Quality:** `r sprintf("%.0f/100", get_quality("expanded_08"))`

## Variant 19: Expanded + Set2

```{r variant-19}
#| fig-height: 6
#| fig-width: 8

render_plot_by_name("expanded_09")
```

**Quality:** `r sprintf("%.0f/100", get_quality("expanded_09"))`

## Variant 20: Expanded + Dark2

```{r variant-20}
#| fig-height: 6
#| fig-width: 8

render_plot_by_name("expanded_10")
```

**Quality:** `r sprintf("%.0f/100", get_quality("expanded_10"))`

## Variant 21: Compact + Hawk Natural

```{r variant-21}
#| fig-height: 6
#| fig-width: 8

render_plot_by_name("compact_11")
```

**Quality:** `r sprintf("%.0f/100", get_quality("compact_11"))`

## Variant 22: Compact + Hawk Vivid

```{r variant-22}
#| fig-height: 6
#| fig-width: 8

render_plot_by_name("compact_12")
```

**Quality:** `r sprintf("%.0f/100", get_quality("compact_12"))`

## Variant 23: Expanded + Hawk Natural

```{r variant-23}
#| fig-height: 6
#| fig-width: 8

render_plot_by_name("expanded_11")
```

**Quality:** `r sprintf("%.0f/100", get_quality("expanded_11"))`

## Variant 24: Expanded + Hawk Vivid

```{r variant-24}
#| fig-height: 6
#| fig-width: 8

render_plot_by_name("expanded_12")
```

**Quality:** `r sprintf("%.0f/100", get_quality("expanded_12"))`

:::

---

# Scale Comparison by Palette

Compare compact (scale 0.85) vs expanded (scale 2.25) side-by-side for each palette. Use this to select your preferred scale setting.

::: {.panel-tabset}

## Plasma

::: {layout-ncol=2}

```{r scale-plasma-compact}
#| fig-height: 6
#| fig-width: 8

render_plot_by_name("compact_01")
```

**Variant 1** | Compact (0.85) | Quality: `r sprintf("%.0f/100", get_quality("compact_01"))`

```{r scale-plasma-expanded}
#| fig-height: 6
#| fig-width: 8

render_plot_by_name("expanded_01")
```

**Variant 11** | Expanded (2.25) | Quality: `r sprintf("%.0f/100", get_quality("expanded_01"))`

:::

## Viridis

::: {layout-ncol=2}

```{r scale-viridis-compact}
#| fig-height: 6
#| fig-width: 8

render_plot_by_name("compact_02")
```

**Variant 2** | Compact (0.85) | Quality: `r sprintf("%.0f/100", get_quality("compact_02"))`

```{r scale-viridis-expanded}
#| fig-height: 6
#| fig-width: 8

render_plot_by_name("expanded_02")
```

**Variant 12** | Expanded (2.25) | Quality: `r sprintf("%.0f/100", get_quality("expanded_02"))`

:::

## Magma

::: {layout-ncol=2}

```{r scale-magma-compact}
#| fig-height: 6
#| fig-width: 8

render_plot_by_name("compact_03")
```

**Variant 3** | Compact (0.85) | Quality: `r sprintf("%.0f/100", get_quality("compact_03"))`

```{r scale-magma-expanded}
#| fig-height: 6
#| fig-width: 8

render_plot_by_name("expanded_03")
```

**Variant 13** | Expanded (2.25) | Quality: `r sprintf("%.0f/100", get_quality("expanded_03"))`

:::

## Inferno

::: {layout-ncol=2}

```{r scale-inferno-compact}
#| fig-height: 6
#| fig-width: 8

render_plot_by_name("compact_04")
```

**Variant 4** | Compact (0.85) | Quality: `r sprintf("%.0f/100", get_quality("compact_04"))`

```{r scale-inferno-expanded}
#| fig-height: 6
#| fig-width: 8

render_plot_by_name("expanded_04")
```

**Variant 14** | Expanded (2.25) | Quality: `r sprintf("%.0f/100", get_quality("expanded_04"))`

:::

## Cividis

::: {layout-ncol=2}

```{r scale-cividis-compact}
#| fig-height: 6
#| fig-width: 8

render_plot_by_name("compact_05")
```

**Variant 5** | Compact (0.85) | Quality: `r sprintf("%.0f/100", get_quality("compact_05"))`

```{r scale-cividis-expanded}
#| fig-height: 6
#| fig-width: 8

render_plot_by_name("expanded_05")
```

**Variant 15** | Expanded (2.25) | Quality: `r sprintf("%.0f/100", get_quality("expanded_05"))`

:::

## Rocket

::: {layout-ncol=2}

```{r scale-rocket-compact}
#| fig-height: 6
#| fig-width: 8

render_plot_by_name("compact_06")
```

**Variant 6** | Compact (0.85) | Quality: `r sprintf("%.0f/100", get_quality("compact_06"))`

```{r scale-rocket-expanded}
#| fig-height: 6
#| fig-width: 8

render_plot_by_name("expanded_06")
```

**Variant 16** | Expanded (2.25) | Quality: `r sprintf("%.0f/100", get_quality("expanded_06"))`

:::

## Mako

::: {layout-ncol=2}

```{r scale-mako-compact}
#| fig-height: 6
#| fig-width: 8

render_plot_by_name("compact_07")
```

**Variant 7** | Compact (0.85) | Quality: `r sprintf("%.0f/100", get_quality("compact_07"))`

```{r scale-mako-expanded}
#| fig-height: 6
#| fig-width: 8

render_plot_by_name("expanded_07")
```

**Variant 17** | Expanded (2.25) | Quality: `r sprintf("%.0f/100", get_quality("expanded_07"))`

:::

## Turbo

::: {layout-ncol=2}

```{r scale-turbo-compact}
#| fig-height: 6
#| fig-width: 8

render_plot_by_name("compact_08")
```

**Variant 8** | Compact (0.85) | Quality: `r sprintf("%.0f/100", get_quality("compact_08"))`

```{r scale-turbo-expanded}
#| fig-height: 6
#| fig-width: 8

render_plot_by_name("expanded_08")
```

**Variant 18** | Expanded (2.25) | Quality: `r sprintf("%.0f/100", get_quality("expanded_08"))`

:::

## Set2

::: {layout-ncol=2}

```{r scale-set2-compact}
#| fig-height: 6
#| fig-width: 8

render_plot_by_name("compact_09")
```

**Variant 9** | Compact (0.85) | Quality: `r sprintf("%.0f/100", get_quality("compact_09"))`

```{r scale-set2-expanded}
#| fig-height: 6
#| fig-width: 8

render_plot_by_name("expanded_09")
```

**Variant 19** | Expanded (2.25) | Quality: `r sprintf("%.0f/100", get_quality("expanded_09"))`

:::

## Dark2

::: {layout-ncol=2}

```{r scale-dark2-compact}
#| fig-height: 6
#| fig-width: 8

render_plot_by_name("compact_10")
```

**Variant 10** | Compact (0.85) | Quality: `r sprintf("%.0f/100", get_quality("compact_10"))`

```{r scale-dark2-expanded}
#| fig-height: 6
#| fig-width: 8

render_plot_by_name("expanded_10")
```

**Variant 20** | Expanded (2.25) | Quality: `r sprintf("%.0f/100", get_quality("expanded_10"))`

:::

## Hawk Natural

::: {layout-ncol=2}

```{r scale-hawk-natural-compact}
#| fig-height: 6
#| fig-width: 8

render_plot_by_name("compact_11")
```

**Variant 11** | Compact (0.85) | Quality: `r sprintf("%.0f/100", get_quality("compact_11"))`

```{r scale-hawk-natural-expanded}
#| fig-height: 6
#| fig-width: 8

render_plot_by_name("expanded_11")
```

**Variant 23** | Expanded (2.25) | Quality: `r sprintf("%.0f/100", get_quality("expanded_11"))`

:::

## Hawk Vivid

::: {layout-ncol=2}

```{r scale-hawk-vivid-compact}
#| fig-height: 6
#| fig-width: 8

render_plot_by_name("compact_12")
```

**Variant 12** | Compact (0.85) | Quality: `r sprintf("%.0f/100", get_quality("compact_12"))`

```{r scale-hawk-vivid-expanded}
#| fig-height: 6
#| fig-width: 8

render_plot_by_name("expanded_12")
```

**Variant 24** | Expanded (2.25) | Quality: `r sprintf("%.0f/100", get_quality("expanded_12"))`

:::

:::

---

# Plot Configuration Matrix

```{r configuration-matrix}
# Extract configuration details from registry artifacts
config_df <- data.frame(
  ID = names(plot_lookup),
  Scale = sapply(names(plot_lookup), function(x) {
    ifelse(grepl("compact", x, ignore.case=TRUE), "0.85", "2.25")
  }),
  Palette = sapply(names(plot_lookup), function(x) {
    # Extract palette from artifact name
    suffix <- gsub(".*_", "", x)
    dplyr::case_when(
      suffix == "01" ~ "plasma",
      suffix == "02" ~ "viridis",
      suffix == "03" ~ "magma",
      suffix == "04" ~ "inferno",
      suffix == "05" ~ "cividis",
      suffix == "06" ~ "rocket",
      suffix == "07" ~ "mako",
      suffix == "08" ~ "turbo",
      suffix == "09" ~ "set2",
      suffix == "10" ~ "dark2",
      TRUE ~ "unknown"
    )
  }),
  Quality = sapply(names(plot_lookup), function(x) sprintf("%.0f", get_quality(x))),
  Time = sapply(names(plot_lookup), function(x) sprintf("%.2fs", get_time(x))),
  Status = sapply(names(plot_lookup), function(x) {
    if (file.exists(plot_lookup[[x]]$file_path)) "success" else "failed"
  }),
  stringsAsFactors = FALSE
) %>%
  dplyr::mutate(
    Category = ifelse(grepl("compact", ID, ignore.case = TRUE), "Compact", "Expanded"),
    Status_Symbol = ifelse(Status == "success", "✓", "✗")
  )

kableExtra::kable(
  config_df,
  col.names = c("Plot ID", "Scale", "Palette", "Quality", "Time", "Status", "Category", "Status Symbol"),
  caption = "Plot Variant Configuration Summary",
  booktabs = TRUE
) %>%
  kableExtra::kable_styling(bootstrap_options = c("striped", "hover", "condensed"),
                font_size = 10) %>%
  kableExtra::column_spec(6, color = ifelse(config_df$Status == "success", "green", "red"))
```

---

# Quality Metrics Analysis

```{r quality-analysis}
#| fig-height: 6
#| fig-width: 8

# Plot quality distribution
quality_plot_df <- config_df %>%
  mutate(Quality_Numeric = as.numeric(Quality))

ggplot(quality_plot_df, aes(x = reorder(ID, Quality_Numeric), 
                             y = Quality_Numeric, fill = Category)) +
  geom_col() +
  geom_hline(yintercept = 90, linetype = "dashed", color = "green") +
  geom_hline(yintercept = 75, linetype = "dashed", color = "orange") +
  annotate("text", x = 1, y = 92, label = "Excellent (90+)", 
           color = "green", size = 3, hjust = 0) +
  annotate("text", x = 1, y = 77, label = "Good (75+)", 
           color = "orange", size = 3, hjust = 0) +
  labs(title = "Plot Quality Scores (All Variants)",
       subtitle = "Higher is better | Thresholds: Excellent ≥90, Good ≥75",
       x = "Plot ID",
       y = "Quality Score (0-100)",
       fill = "Category") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_fill_manual(values = c("Compact" = "steelblue", "Expanded" = "darkgreen"))
```

## Generation Time Analysis

```{r time-analysis}
#| fig-height: 6
#| fig-width: 8

time_plot_df <- config_df %>%
  dplyr::mutate(Time_Numeric = as.numeric(gsub("s", "", Time)))

ggplot(time_plot_df, aes(x = Category, y = Time_Numeric, fill = Category)) +
  geom_boxplot(alpha = 0.7) +
  geom_jitter(width = 0.2, alpha = 0.5) +
  labs(title = "Generation Time Distribution",
       subtitle = "Compact vs Expanded variants",
       x = "Variant Category",
       y = "Generation Time (seconds)") +
  theme_minimal() +
  scale_fill_manual(values = c("Compact" = "steelblue", "Expanded" = "darkgreen"))
```

---

# How to Use This Gallery

## Workflow for Selecting Your Plot

**Step 1:** Browse the **Scale Comparison by Palette** section below  
- Compare compact vs expanded side-by-side for each of the 10 palettes
- Identify which scale and palette combination works best for your needs
- Note the variant number (1-20) shown under each plot

**Step 2:** Navigate to the **All Variants** section at the top  
- Find the tab for your chosen variant number
- View the full-size plot in detail
- Confirm your selection

**Step 3:** Use the variant number for export or reporting

## When to Use Compact Variants (1-10)

✓ **High temporal density** (many years)  
✓ **Overview visualization** for reports  
✓ **Screen presentations** with limited space  
✓ **Comparative analysis** across multiple plots

## When to Use Expanded Variants (11-20)

✓ **Distribution shape emphasis**  
✓ **Publication figures** (scientific papers)  
✓ **Detailed examination** of year-specific patterns  
✓ **Poster presentations** with large format

## Palette Selection Guide

| Palette | Variants | Best For | Characteristics |
|---------|----------|----------|-----------------|
| **Plasma** | 1, 11 | General use | High contrast, perceptually uniform |
| **Viridis** | 2, 12 | Colorblind-safe | Default, widely recognized |
| **Magma** | 3, 13 | Print media | Works well in grayscale |
| **Inferno** | 4, 14 | Dark backgrounds | High luminance range |
| **Cividis** | 5, 15 | Accessibility | Optimized for CVD |
| **Rocket** | 6, 16 | High contrast | Bold emphasis |
| **Mako** | 7, 17 | Cool tones | Professional look |
| **Turbo** | 8, 18 | Maximum distinction | Full spectrum |
| **Set2** | 9, 19 | Categorical emphasis | Qualitative palette |
| **Dark2** | 10, 20 | Strong contrast | Distinct colors |

---

# Export Information

All plots generated and saved to: **`r result$output_dir`**

```{r export-info}
export_df <- data.frame(
  Plot_ID = names(plot_lookup),
  Filename = sapply(names(plot_lookup), function(x) basename(plot_lookup[[x]]$file_path)),
  Size_MB = sapply(names(plot_lookup), function(x) {
    path <- plot_lookup[[x]]$file_path
    if (file.exists(path)) sprintf("%.2f", file.info(path)$size / 1024^2) else "0.00"
  }),
  Status = sapply(names(plot_lookup), function(x) {
    if (file.exists(plot_lookup[[x]]$file_path)) "success" else "failed"
  }),
  stringsAsFactors = FALSE
)

kableExtra::kable(export_df,
      col.names = c("Plot ID", "Filename", "Size (MB)", "Status"),
      caption = "Exported Plot Files",
      booktabs = TRUE) %>%
  kableExtra::kable_styling(bootstrap_options = c("striped", "hover", "condensed"),
                font_size = 10)
```

**Total Size:** `r sprintf("%.2f MB", sum(as.numeric(export_df$Size_MB), na.rm=TRUE))`

---

# Reproducibility

```{r reproducibility-code}
#| echo: true
#| eval: false

# Generate all plots via pipeline with artifact registry:
source(here::here("R", "pipeline", "pipeline.R"))
result <- run_pipeline(verbose = TRUE, use_registry = TRUE)

# Load artifacts from registry:
registry <- yaml::read_yaml(here::here("R", "config", "artifact_registry.yaml"))

# Access individual plots by name:
compact_plot_path <- registry$artifacts[["compact_01"]]$file_path

# Include in report:
knitr::include_graphics(compact_plot_path)

# Copy individual plot:
file.copy(compact_plot_path, "custom_name.png", overwrite = TRUE)
```

---

**Gallery Generated:** `r format(Sys.time(), "%Y-%m-%d %H:%M:%S")`  
**Plots Rendered:** `r total_plots`/20  
**Success Rate:** `r sprintf("%.0f%%", success_rate)`  
**Average Quality:** `r sprintf("%.0f/100", avg_quality)`
