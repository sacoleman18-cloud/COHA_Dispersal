# ==============================================================================
# R/functions/phase3_plot_operations.R
# ==============================================================================
# PURPOSE
# -------
# Phase 3 plot operations with structured returns and error recovery.
# All functions return result objects with status, message, quality metrics.
# Unlike Phase 1, plot generation failures don't stop pipeline.
#
# DEPENDS ON
# ----------
# - R/functions/assertions.R (validation)
# - R/functions/logging.R (audit trail)
# - R/functions/robustness.R (result objects)
# - R/functions/utilities.R (directory management)
# - ggplot2, ggridges, dplyr
#
# INPUTS
# ------
# Data frames, plot configurations, output directories
#
# OUTPUTS
# -------
# Structured result objects with status, plots, quality metrics
# PNG files to disk
#
# USAGE
# -----
# source(\"R/functions/phase3_plot_operations.R\")\n# result <- generate_plot_safe(df, config, \"compact_01\", output_dir)\n# summary <- generate_all_plots_safe(df, configs, output_dir, verbose = TRUE)\n#\n# CHANGELOG\n# ---------\n# 2026-02-10 (v1.0.0): Phase 3 - Initial plot operations\n#   - generate_plot_safe() - Single plot with error recovery\n#   - generate_all_plots_safe() - Batch generation with continue-on-error\n#\n# ==============================================================================\n\n#' Safely Generate Single Plot with Error Recovery\n#'\n#' @description\n#' Generates ridgeline plot with comprehensive error handling.\n#' Returns structured result instead of failing on error.\n#' If plot generation fails, continues pipeline with error logged.\n#'\n#' @param df Data frame. Data to plot.\n#' @param plot_config List. Plot specification with fields:\n#'   - plot_id: Unique identifier (e.g., \"compact_01\")\n#'   - scale: Ridgeline scale factor\n#'   - fill: Palette/color specification\n#'   - title: Plot title\n#' @param output_dir Character. Directory to save PNG.\n#' @param verbose Logical. Print progress. Default: FALSE.\n#' @param dpi Integer. PNG resolution. Default: 300.\n#' @param width Numeric. PNG width in inches. Default: 10.\n#' @param height Numeric. PNG height in inches. Default: 6.\n#'\n#' @return List. Structured result with fields:\n#'   - status: \"success\", \"partial\", or \"failed\"\n#'   - message: Human-readable status\n#'   - plot_id: Plot identifier\n#'   - plot: ggplot object (if status != \"failed\")\n#'   - output_path: Where PNG saved (if success)\n#'   - file_size_mb: Size of PNG file (if saved)\n#'   - generation_time: Seconds to generate plot\n#'   - quality_score: 0-100 quality rating\n#'   - errors: List of errors encountered\n#'   - warnings: List of non-blocking issues\n#'   - timestamp: When operation completed\n#'   - duration_secs: Total operation time\n#'\n#' @details\n#' **Error Recovery:**\n#' - If data missing: logs error, returns status=\"failed\"\n#' - If plot generation fails: logs error, returns status=\"failed\"\n#' - If file save fails: logs error, returns plot object anyway\n#' - Never stops execution; returns status for caller to decide\n#'\n#' **Pre-Checks:**\n#' 1. Data is data frame and not empty\n#' 2. Output directory exists (creates if missing)\n#' 3. Plot config has required fields\n#'\n#' **Quality Score Factors:**\n#' - Data completeness (30%)\n#' - Plot generation success (40%)\n#' - File save success (20%)\n#' - Generation time reasonable (10%)\n#'\n#' @examples\n#' \\dontrun{\n#' config <- list(\n#'   plot_id = \"compact_01\",\n#'   scale = 0.85,\n#'   fill = \"plasma\",\n#'   title = \"Mass Distribution (Compact, Plasma)\"\n#' )\n#'\n#' result <- generate_plot_safe(\n#'   df = hawk_data,\n#'   plot_config = config,\n#'   output_dir = here::here(\"results\", \"plots\", \"ridgeline\", \"variants\"),\n#'   verbose = TRUE\n#' )\n#'\n#' if (result$status == \"success\") {\n#'   message(sprintf(\"Plot saved: %s (%.2f MB)\",\n#'                  result$output_path, result$file_size_mb))\n#' } else {\n#'   warning(sprintf(\"Plot failed: %s\", result$message))\n#' }\n#' }\n#'\n#' @export\ngenerate_plot_safe <- function(df,\n                                plot_config,\n                                output_dir,\n                                verbose = FALSE,\n                                dpi = 300,\n                                width = 10,\n                                height = 6) {\n  # Initialize result\n  result <- create_result(\"generate_plot_safe\", verbose)\n  result$plot_id <- plot_config$plot_id %||% \"unknown\"\n  start_time <- start_timer()\n  \n  if (verbose) {\n    log_entry(sprintf(\"Generating plot: %s\", result$plot_id), verbose = TRUE)\n  }\n  \n  # 1. DEFENSIVE CHECKS\n  tryCatch(\n    {\n      assert_data_frame(df, \"input data\")\n      assert_not_empty(df, \"input data\")\n      assert_directory_exists(output_dir, create = TRUE)\n      assert_scalar_string(plot_config$plot_id, \"plot_id\")\n    },\n    error = function(e) {\n      result <<- add_error(\n        result,\n        format_error_message(\n          sprintf(\"plot_%s\", result$plot_id),\n          e$message,\n          \"Check input data and output directory\"\n        ),\n        verbose\n      )\n    }\n  )\n  \n  if (result$status == \"failed\") {\n    result$duration_secs <- stop_timer(start_time)\n    return(invisible(result))\n  }\n  \n  # 2. BUILD OUTPUT PATH\n  timestamp <- format(Sys.time(), \"%Y%m%d_%H%M%S\")\n  output_file <- sprintf(\"%s_%s.png\", result$plot_id, timestamp)\n  output_path <- file.path(output_dir, output_file)\n  \n  if (verbose) {\n    message(sprintf(\"[PLOT] Output: %s\", output_file))\n  }\n  \n  # 3. GENERATE PLOT\n  plot_generation_time <- NA_real_\n  plot_obj <- NULL\n  \n  tryCatch(\n    {\n      plot_start <- start_timer()\n      \n      # Create ridgeline plot using config\n      plot_obj <- ggplot2::ggplot(\n        df,\n        ggplot2::aes(\n          x = mass,\n          y = year,\n          fill = origin\n        )\n      ) +\n        ggridges::geom_density_ridges(\n          scale = plot_config$scale %||% 1.0,\n          alpha = 0.7,\n          show.legend = TRUE\n        ) +\n        ggplot2::scale_fill_viridis_d(\n          option = plot_config$fill %||% \"plasma\"\n        ) +\n        ggplot2::labs(\n          title = plot_config$title %||% result$plot_id,\n          x = \"Mass (g)\",\n          y = \"Year\",\n          fill = \"Origin\"\n        ) +\n        ggplot2::theme_minimal() +\n        ggplot2::theme(\n          plot.title = ggplot2::element_text(size = 14, face = \"bold\"),\n          axis.title = ggplot2::element_text(size = 12),\n          legend.position = \"bottom\"\n        )\n      \n      plot_generation_time <- stop_timer(plot_start)\n      \n      if (verbose) {\n        message(sprintf(\"[PLOT] Generated in %.2f seconds\", plot_generation_time))\n      }\n    },\n    error = function(e) {\n      result <<- add_error(\n        result,\n        format_error_message(\n          sprintf(\"plot_%s\", result$plot_id),\n          sprintf(\"Plot generation failed: %s\", e$message),\n          \"Check plot config fields: scale, fill, title\"\n        ),\n        verbose\n      )\n    }\n  )\n  \n  if (result$status == \"failed\") {\n    result$duration_secs <- stop_timer(start_time)\n    return(invisible(result))\n  }\n  \n  result$plot <- plot_obj\n  \n  # 4. SAVE PLOT TO DISK\n  file_size_mb <- NA_real_\n  \n  tryCatch(\n    {\n      if (verbose) message(\"[PLOT] Saving to disk...\")\n      \n      ggplot2::ggsave(\n        filename = output_path,\n        plot = plot_obj,\n        width = width,\n        height = height,\n        dpi = dpi,\n        device = \"png\"\n      )\n      \n      # Get file size\n      file_info <- file.info(output_path)\n      file_size_mb <- file_info$size / (1024 * 1024)\n      \n      if (verbose) {\n        message(sprintf(\"[PLOT] âœ“ Saved (%s, %.2f MB)\",\n                       output_file, file_size_mb))\n      }\n      \n      result <- set_result_status(\n        result,\n        \"success\",\n        sprintf(\"Plot generated and saved: %s\", result$plot_id),\n        verbose\n      )\n    },\n    error = function(e) {\n      result <<- add_warning(\n        result,\n        format_error_message(\n          sprintf(\"plot_%s\", result$plot_id),\n          sprintf(\"Failed to save PNG: %s\", e$message),\n          sprintf(\"Check write permissions in %s\", output_dir)\n        ),\n        verbose\n      )\n      # Change status to partial (plot generated but not saved)\n      result$status <<- \"partial\"\n    }\n  )\n  \n  # 5. COMPUTE QUALITY SCORE\n  quality_components <- list(\n    generation = if (!is.na(plot_generation_time)) 100 else 0,\n    file_saved = if (!is.na(file_size_mb)) 100 else 50,\n    status = if (result$status == \"success\") 100 else if (result$status == \"partial\") 75 else 0\n  )\n  \n  result <- add_quality_metrics(result, quality_components)\n  \n  # 6. FINALIZE\n  result$output_path <- output_path\n  result$file_size_mb <- file_size_mb\n  result$generation_time <- plot_generation_time\n  result$duration_secs <- stop_timer(start_time)\n  result$timestamp <- Sys.time()\n  \n  if (verbose) {\n    log_success(\n      sprintf(\"Generated plot %s\", result$plot_id),\n      sprintf(\"quality: %.0f/100, time: %.2f sec\",\n             result$quality_score, result$duration_secs),\n      verbose = TRUE\n    )\n  }\n  \n  invisible(result)\n}\n\n#' Safely Generate All Configured Plots\n#'\n#' @description\n#' Generate all plots from configuration list with error recovery.\n#' If one plot fails, continues with remaining plots.\n#' Returns summary of all results.\n#'\n#' @param df Data frame. Data for all plots.\n#' @param plot_configs List. List of plot configurations.\n#' @param output_dir Character. Base output directory.\n#' @param verbose Logical. Print progress. Default: FALSE.\n#' @param dpi Integer. PNG resolution. Default: 300.\n#' @param stop_on_first_error Logical. Stop if any plot fails?\n#'   Default: FALSE (continue on error).\n#'\n#' @return List. Summary result with fields:\n#'   - status: \"success\", \"partial\", or \"failed\"\n#'   - message: Summary message\n#'   - plots_generated: Number of successful plots\n#'   - plots_failed: Number of failed plots\n#'   - plots_total: Total attempted\n#'   - generation_times: Vector of per-plot times\n#'   - output_dir: Directory where plots saved\n#'   - success_rate: Percent generated successfully\n#'   - quality_score: Average quality across all\n#'   - results: List of individual plot results\n#'   - errors: All errors encountered\n#'   - warnings: All warnings\n#'   - duration_secs: Total time for all plots\n#'   - timestamp: When batch completed\n#'\n#' @details\n#' **Continue-on-Error Pattern:**\n#' - Individual plot failure logged but doesn't stop batch\n#' - All plots attempted even if some fail\n#' - Summary shows count of successes and failures\n#'\n#' **Status Determination:**\n#' - All success: status = \"success\"\n#' - Some success: status = \"partial\"\n#' - All fail: status = \"failed\"\n#' - OR stop_on_first_error=TRUE and any fails: status = \"failed\"\n#'\n#' **Quality Score:**\n#' Average of individual plot quality scores.\n#' Higher is better (0-100).\n#'\n#' @examples\n#' \\dontrun{\n#' # Generate all 20 ridgeline variants\n#' summary <- generate_all_plots_safe(\n#'   df = hawk_data,\n#'   plot_configs = ridgeline_plot_configs,\n#'   output_dir = here::here(\"results\", \"plots\", \"ridgeline\", \"variants\"),\n#'   verbose = TRUE\n#' )\n#'\n#' # Check results\n#' message(sprintf(\n#'   \"Generated %d/%d plots (success rate: %.0f%%)\",\n#'   summary$plots_generated,\n#'   summary$plots_total,\n#'   summary$success_rate\n#' ))\n#'\n#' # Handle summary status\n#' if (summary$status == \"success\") {\n#'   message(\"All plots generated successfully\")\n#' } else if (summary$status == \"partial\") {\n#'   warning(sprintf(\"Generated %d plots, %d failed\",\n#'                  summary$plots_generated, summary$plots_failed))\n#' } else {\n#'   stop(\"All plots failed\")\n#' }\n#' }\n#'\n#' @export\ngenerate_all_plots_safe <- function(df,\n                                     plot_configs,\n                                     output_dir,\n                                     verbose = FALSE,\n                                     dpi = 300,\n                                     stop_on_first_error = FALSE) {\n  \n  # Initialize summary\n  summary <- create_result(\"generate_all_plots_safe\", verbose)\n  start_time <- start_timer()\n  \n  if (verbose) {\n    message(sprintf(\"[BATCH] Starting batch generation of %d plots\",\n                   length(plot_configs)))\n  }\n  \n  # Pre-checks\n  tryCatch(\n    {\n      assert_data_frame(df, \"data\")\n      assert_not_empty(df, \"data\")\n      assert_directory_exists(output_dir, create = TRUE)\n    },\n    error = function(e) {\n      summary <<- add_error(summary, e$message, verbose)\n    }\n  )\n  \n  if (summary$status == \"failed\") {\n    summary$duration_secs <- stop_timer(start_time)\n    return(invisible(summary))\n  }\n  \n  # Track results\n  individual_results <- list()\n  generation_times <- numeric()\n  quality_scores <- numeric()\n  plots_generated <- 0\n  plots_failed <- 0\n  \n  # Generate each plot\n  for (i in seq_along(plot_configs)) {\n    config <- plot_configs[[i]]\n    plot_id <- config$plot_id %||% sprintf(\"plot_%d\", i)\n    \n    if (verbose) {\n      message(sprintf(\"[BATCH] %d/%d: Generating %s\",\n                     i, length(plot_configs), plot_id))\n    }\n    \n    # Generate plot\n    result <- tryCatch(\n      {\n        generate_plot_safe(\n          df = df,\n          plot_config = config,\n          output_dir = output_dir,\n          verbose = FALSE,  # Suppress individual plot verbosity\n          dpi = dpi\n        )\n      },\n      error = function(e) {\n        # Wrap external error\n        res <- create_result(sprintf(\"plot_%s\", plot_id))\n        res <- add_error(res, sprintf(\"Unexpected error: %s\", e$message))\n        res\n      }\n    )\n    \n    # Store result\n    individual_results[[length(individual_results) + 1]] <- result\n    \n    # Track metrics\n    if (result$status != \"failed\") {\n      plots_generated <- plots_generated + 1\n      if (!is.na(result$duration_secs)) {\n        generation_times <- c(generation_times, result$duration_secs)\n      }\n    } else {\n      plots_failed <- plots_failed + 1\n    }\n    \n    if (!is.na(result$quality_score)) {\n      quality_scores <- c(quality_scores, result$quality_score)\n    }\n    \n    # Check stop-on-error flag\n    if (stop_on_first_error && result$status == \"failed\") {\n      if (verbose) {\n        message(sprintf(\"[BATCH] Stopping after first failure: %s\", plot_id))\n      }\n      break\n    }\n  }\n  \n  # 6. DETERMINE SUMMARY STATUS\n  if (plots_failed == 0) {\n    summary <- set_result_status(\n      summary,\n      \"success\",\n      sprintf(\"All %d plots generated successfully\", plots_generated),\n      verbose\n    )\n  } else if (plots_generated > 0) {\n    summary <- set_result_status(\n      summary,\n      \"partial\",\n      sprintf(\"Generated %d/%d plots (%d failed)\",\n             plots_generated,\n             plots_generated + plots_failed,\n             plots_failed),\n      verbose\n    )\n  } else {\n    summary <- add_error(\n      summary,\n      format_error_message(\n        \"generate_all_plots\",\n        sprintf(\"All %d plots failed\", plots_failed),\n        \"Check data and plot configurations\"\n      ),\n      verbose\n    )\n  }\n  \n  # 7. ASSEMBLE SUMMARY METRICS\n  summary$plots_generated <- plots_generated\n  summary$plots_failed <- plots_failed\n  summary$plots_total <- plots_generated + plots_failed\n  summary$output_dir <- output_dir\n  summary$success_rate <- (plots_generated / summary$plots_total) * 100\n  summary$generation_times <- generation_times\n  summary$results <- individual_results\n  \n  # Average quality score\n  if (length(quality_scores) > 0) {\n    summary$quality_score <- mean(quality_scores)\n  } else {\n    summary$quality_score <- 0\n  }\n  \n  # Collect all errors and warnings\n  for (result in individual_results) {\n    if (length(result$errors) > 0) {\n      summary$errors <- c(summary$errors, result$errors)\n    }\n    if (length(result$warnings) > 0) {\n      summary$warnings <- c(summary$warnings, result$warnings)\n    }\n  }\n  \n  # 8. FINALIZE\n  summary$duration_secs <- stop_timer(start_time)\n  summary$timestamp <- Sys.time()\n  \n  if (verbose) {\n    message(sprintf(\n      \"[BATCH] Complete: %d/%d plots (%.0f%% success, quality: %.0f/100, time: %.1fs)\",\n      plots_generated,\n      summary$plots_total,\n      summary$success_rate,\n      summary$quality_score,\n      summary$duration_secs\n    ))\n  }\n  \n  invisible(summary)\n}\n\n# ==============================================================================\n# END R/functions/phase3_plot_operations.R\n# ==============================================================================\n